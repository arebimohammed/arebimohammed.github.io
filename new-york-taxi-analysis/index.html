<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Digging Deep Into the New York Taxi Dataset - Mohammed Arebi</title><meta name="Description" content="An open-source exploration of the city&#39;s taxi life, boroughs, neighborhoods, and more via the prism of publicly available taxi data"><meta property="og:title" content="Digging Deep Into the New York Taxi Dataset" />
<meta property="og:description" content="An open-source exploration of the city&#39;s taxi life, boroughs, neighborhoods, and more via the prism of publicly available taxi data" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://arebimohammed.github.io/new-york-taxi-analysis/" /><meta property="og:image" content="https://arebimohammed.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-16T20:29:01+08:00" />
<meta property="article:modified_time" content="2022-11-01T08:12:56+01:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://arebimohammed.github.io/logo.png"/>

<meta name="twitter:title" content="Digging Deep Into the New York Taxi Dataset"/>
<meta name="twitter:description" content="An open-source exploration of the city&#39;s taxi life, boroughs, neighborhoods, and more via the prism of publicly available taxi data"/>
<meta name="application-name" content="Mohammed Arebi">
<meta name="apple-mobile-web-app-title" content="Mohammed Arebi"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://arebimohammed.github.io/new-york-taxi-analysis/" /><link rel="prev" href="https://arebimohammed.github.io/applying-oversampling/" /><link rel="next" href="https://arebimohammed.github.io/confounding-variables/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Digging Deep Into the New York Taxi Dataset",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/arebimohammed.github.io\/new-york-taxi-analysis\/"
        },"image": ["https:\/\/arebimohammed.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "blogging, data science, machine learning, project, python, data analysis","wordcount":  12464 ,
        "url": "https:\/\/arebimohammed.github.io\/new-york-taxi-analysis\/","datePublished": "2020-10-16T20:29:01+08:00","dateModified": "2022-11-01T08:12:56+01:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/arebimohammed.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Mohammed Arebi"
            },"description": "An open-source exploration of the city's taxi life, boroughs, neighborhoods, and more via the prism of publicly available taxi data"
    }
    </script></head>
    <body header-desktop="auto" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Mohammed Arebi"><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/about-me"> About </a><a class="menu-item" href="/resume/my-resume"> Resume </a><a class="menu-item" href="/projects/my-projects"> Projects </a><a class="menu-item" href="https://github.com/arebimohammed" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Mohammed Arebi"><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/about-me" title="">About</a><a class="menu-item" href="/resume/my-resume" title="">Resume</a><a class="menu-item" href="/projects/my-projects" title="">Projects</a><a class="menu-item" href="https://github.com/arebimohammed" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Digging Deep Into the New York Taxi Dataset</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Mohammed Arebi</a></span>&nbsp;<span class="post-category">included in <a href="/categories/data-analysis/"><i class="far fa-folder fa-fw"></i>Data Analysis</a>&nbsp;<a href="/categories/machine-learning/"><i class="far fa-folder fa-fw"></i>Machine Learning</a>&nbsp;<a href="/categories/big-data/"><i class="far fa-folder fa-fw"></i>Big Data</a>&nbsp;<a href="/categories/interactive/"><i class="far fa-folder fa-fw"></i>Interactive</a>&nbsp;<a href="/categories/data-visualisation/"><i class="far fa-folder fa-fw"></i>Data Visualisation</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-10-16">2020-10-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;12464 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;59 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/New-York-Taxi-Analysis/new-york.jpeg"
        data-srcset="/posts/New-York-Taxi-Analysis/new-york.jpeg, /posts/New-York-Taxi-Analysis/new-york.jpeg 1.5x, /posts/New-York-Taxi-Analysis/new-york.jpeg 2x"
        data-sizes="auto"
        alt="/posts/New-York-Taxi-Analysis/new-york.jpeg"
        title="An open-source exploration of the city&#39;s taxi life, boroughs, neighborhoods, and more via the prism of publicly available taxi data" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#the-process">The Process</a></li>
    <li><a href="#data-collection">Data Collection</a></li>
    <li><a href="#data-cleaning">Data Cleaning</a>
      <ul>
        <li><a href="#import-libraries-and-data-loading">Import Libraries and Data Loading</a></li>
        <li><a href="#convert-dates-to-datetime-type">Convert dates to datetime type</a></li>
        <li><a href="#location-data-cleaning">Location Data Cleaning</a>
          <ul>
            <li><a href="#trips-only-within-new-york-city">Trips only within New York City</a></li>
          </ul>
        </li>
        <li><a href="#trip-dates-and-duration-cleaning">Trip Dates and Duration Cleaning</a></li>
        <li><a href="#trip-distance-cleaning">Trip Distance Cleaning</a></li>
        <li><a href="#trip-speed-cleaning">Trip Speed Cleaning</a></li>
        <li><a href="#trip-total-amount-fare-amount-surcharge-tax-tolls-and-tip-cleaning">Trip Total Amount, Fare Amount, Surcharge, Tax, Tolls and Tip Cleaning</a></li>
        <li><a href="#passenger-count-cleaning">Passenger Count Cleaning</a></li>
        <li><a href="#categorical-columns-cleaning">Categorical Columns Cleaning</a></li>
      </ul>
    </li>
    <li><a href="#data-analysis">Data Analysis</a>
      <ul>
        <li><a href="#import-libraries-and-data-loading-1">Import Libraries and Data Loading</a></li>
        <li><a href="#convert-dates-to-datetime">Convert dates to datetime</a></li>
        <li><a href="#splitting-data-for-test-and-train-sets">Splitting data for test and train sets</a></li>
        <li><a href="#q1-how-much-do-taxis-earn-per-trip-if-they-can-only-drive-30km-or-50km-per-trip-compared-to-taxis-that-have-no-limit-ie-what-is-the-average-income-for-trips-30km-or-50km-compared-to-the-total-revenue">Q1: How much do taxis earn per trip if they can only drive 30km or 50km per trip, compared to taxis that have no limit? (i.e. what is the average income for trips &lt;30km or &lt;50km compared to the total revenue?)</a></li>
        <li><a href="#q2-do-more-taxi-trips-start-at-the-north-or-south">Q2: Do more taxi trips start at the North or South?</a></li>
        <li><a href="#adding-date-features">Adding date features</a></li>
        <li><a href="#adding-direction-feature">Adding direction feature</a></li>
        <li><a href="#q3-traffic-speed-analysis">Q3: Traffic Speed Analysis</a>
          <ul>
            <li><a href="#trip-speed-per-hour-of-day">Trip Speed Per Hour of Day</a></li>
            <li><a href="#trip-speed-per-day-of-week">Trip Speed Per Day of Week</a></li>
            <li><a href="#trip-speed-per-both-hour-of-day-and-day-of-week">Trip Speed per both Hour of Day and Day of Week</a></li>
            <li><a href="#traffic-speed-per-time-of-day">Traffic Speed per Time of Day</a></li>
            <li><a href="#traffic-speed-per-month">Traffic Speed per Month</a></li>
            <li><a href="#traffic-speed-per-direction-of-trip">Traffic Speed per Direction of Trip</a></li>
            <li><a href="#adding-borough-information">Adding borough information</a></li>
            <li><a href="#traffic-speed-between-new-york-city-boroughs">Traffic Speed between New York City Boroughs</a></li>
          </ul>
        </li>
        <li><a href="#q4-traffic-volume-analysis">Q4: Traffic Volume Analysis</a>
          <ul>
            <li><a href="#traffic-volume-per-hour-of-day">Traffic Volume Per Hour of Day</a></li>
            <li><a href="#traffic-volume-per-day-of-week">Traffic Volume Per Day of Week</a></li>
            <li><a href="#traffic-volume-per-both-hour-of-day-and-day-of-week">Traffic Volume per both Hour of Day and Day of Week</a></li>
            <li><a href="#traffic-volume-per-time-of-day">Traffic Volume per Time of Day</a></li>
            <li><a href="#traffic-volume-per-month">Traffic Volume per Month</a></li>
            <li><a href="#traffic-volume-per-direction-of-trip">Traffic Volume per Direction of Trip</a></li>
            <li><a href="#traffic-volume-between-nyc-boroughs">Traffic Volume between NYC Boroughs</a></li>
            <li><a href="#traffic-density-per-borough-and-area">Traffic Density per Borough and Area</a></li>
            <li><a href="#traffic-density-throughout-the-year">Traffic Density Throughout the Year</a></li>
          </ul>
        </li>
        <li><a href="#q4-tip-analysis">Q4: Tip Analysis</a>
          <ul>
            <li><a href="#tip-per-hour-of-day">Tip per Hour of Day</a></li>
            <li><a href="#tip-per-day-of-week">Tip per Day of Week</a></li>
            <li><a href="#tip-per-hour-of-day-and-day-of-week">Tip per Hour of Day and Day of Week</a></li>
            <li><a href="#tip-per-time-of-day">Tip per Time of Day</a></li>
            <li><a href="#tip-per-month">Tip per Month</a></li>
            <li><a href="#tip-per-direction">Tip per Direction</a></li>
            <li><a href="#tip-per-borough">Tip per Borough</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><span style="font-size:1.125rem">
<p>This article goes in detail through one of the data science projects I worked on, the New York Taxi dataset which is made available by the <a href="https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page" target="_blank" rel="noopener noreffer">New York City Taxi and Limousine Commission (TLC)</a>. New York is partly known for its yellow taxis (even though there are green taxis we&rsquo;ll focus on only the yellow taxis) and there are millions of taxi rides taken every month as New York is one of the most populous cities in the United States which makes for a very interesting dataset to dive into as there are a lot of analysis possibilities (Geospatial Data Analysis, Time Analysis, Taxi Ride Price Analysis, Traffic Analysis, etc.).</p>
<h2 id="introduction">Introduction</h2>
<hr>
<p>When seen as a whole, the precise trip-level data is more than simply a long list of taxi pickup and drop-off locations: it tells a tale of New York. How much do taxis make each trip if they can only travel 30 or 50 kilometres per trip, as opposed to taxis with no limit? Is it more common for taxi journeys to begin in the north or south? What is the average speed of New York traffic (with regards to taxis)? How does the speed of traffic in New York change during the day? All of these questions, and many more, are addressed in the dataset. And we will answer them as well as others.</p>
<h2 id="the-process">The Process</h2>
<p>The usual data science process starts with business and feasability study, data collection, data cleaning, exploratory data analysis (EDA) and sometimes modelling. Of course there is more to this simple process abstraction, such as model deployment and monitoring but in our case these are skipped as we will focus on the data collection, cleaning and exploratory analysis. We&rsquo;ll now go through the different phases one by one.</p>
<h2 id="data-collection">Data Collection</h2>
<p>The data is taken from this link: <a href="http://www.andresmh.com/nyctaxitrips/" target="_blank" rel="noopener noreffer">NYC Yellow Taxi</a> provided by Andrés Monroy. The link contains data contains compressed files of yellow taxi rides for the year 2013. There are two compressed files one named <code>trip_data</code> is for trip specific data such as the distance, time, etc while the other one named <code>trip_fare</code> contains data regarding the trip fare (hence the name), surcharge, tip, etc. Both files divide the data in 12 CSV files (one for each month). The data is also available in Kaggle for the trip data and trip fare <a href="https://www.kaggle.com/c/nyc-taxi-trip-duration" target="_blank" rel="noopener noreffer">here</a> and <a href="https://www.kaggle.com/c/new-york-city-taxi-fare-prediction" target="_blank" rel="noopener noreffer">here</a> respectively. Kaggle wasn&rsquo;t used as it doesn&rsquo;t contain all the data (even though we are also not using all of it, more below) and for the fare data the data is shuffled between several years. The data dictionary/description can be found here: <a href="https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_yellow.pdf" target="_blank" rel="noopener noreffer">Data Dictionary</a>, note that not all columns are in the data dictionary from the data source somehow but looking further in the analysis they are all made clear and are mostly Intuitive.</p>
<p>After downloading the compressed files and unzipping them they are about 5.4 GB in total, which is quite hefty for my local machine as I am doing the analysis locally on a small machine and not on the cloud. This is where data sampling comes into play. Reservoir random sampling was used to sample 150K records/trips per month of 2013. The code for this is shown here and is also available in the projects <a href="https://github.com/arebimohammed/New-York-Yellow-Taxi-Data-Analysis-and-ML-Project" target="_blank" rel="noopener noreffer">github repo</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&#34;display.max_columns&#34;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reservoir_sample</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">random1</span><span class="p">,</span> <span class="n">random2</span><span class="p">,</span><span class="n">random3</span><span class="p">,</span><span class="n">random4</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    From : https://en.wikipedia.org/wiki/Reservoir_sampling#An_optimal_algorithm
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">random1</span><span class="o">/</span><span class="n">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">skip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">random2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">W</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="n">selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">skip</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">selection</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">values</span><span class="p">[</span><span class="n">random3</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">W</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">random4</span><span class="p">)</span><span class="o">/</span><span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">values</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">df_sample</span><span class="p">(</span><span class="n">filepath1</span><span class="p">,</span><span class="n">filepath2</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">,</span><span class="n">r4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">header1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">header2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">values1</span> <span class="o">=</span> <span class="n">reservoir_sample</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">,</span><span class="n">r4</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">values2</span> <span class="o">=</span> <span class="n">reservoir_sample</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">,</span><span class="n">r4</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">result1</span> <span class="o">=</span> <span class="p">[</span><span class="n">header1</span><span class="p">]</span> <span class="o">+</span> <span class="n">values1</span>
</span></span><span class="line"><span class="cl">        <span class="n">result2</span> <span class="o">=</span> <span class="p">[</span><span class="n">header2</span><span class="p">]</span> <span class="o">+</span> <span class="n">values2</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result2</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">df1</span> <span class="o">=</span> <span class="n">sample_preprocessing</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df2</span> <span class="o">=</span> <span class="n">sample_preprocessing</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">fare</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1">#f2 has to be fare data</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df1</span><span class="p">,</span><span class="n">df2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sample_preprocessing</span><span class="p">(</span><span class="n">df_sample</span><span class="p">,</span> <span class="n">fare</span><span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">df_sample</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">fare</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df_sample</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;hack_license&#34;</span><span class="p">,</span><span class="s2">&#34;vendor_id&#34;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df_sample</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reduce_memory</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">numerics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;int8&#34;</span><span class="p">,</span> <span class="s2">&#34;int16&#34;</span><span class="p">,</span> <span class="s2">&#34;int32&#34;</span><span class="p">,</span> <span class="s2">&#34;int64&#34;</span><span class="p">,</span> <span class="s2">&#34;float16&#34;</span><span class="p">,</span> <span class="s2">&#34;float32&#34;</span><span class="p">,</span> <span class="s2">&#34;float64&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_mem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">col_type</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtypes</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">numerics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c_min</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">c_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_type</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;int&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
</span></span><span class="line"><span class="cl">                    <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
</span></span><span class="line"><span class="cl">                <span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
</span></span><span class="line"><span class="cl">                    <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
</span></span><span class="line"><span class="cl">                <span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_mem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Mem. usage decreased to </span><span class="si">{:.2f}</span><span class="s2"> Mb (</span><span class="si">{:.1f}% r</span><span class="s2">eduction)&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">end_mem</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">start_mem</span> <span class="o">-</span> <span class="n">end_mem</span><span class="p">)</span> <span class="o">/</span> <span class="n">start_mem</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data_file_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&#34;../Data/NYC Trip Data/&#34;</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;_&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">data_file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;../Data/NYC Trip Data/&#34;</span><span class="p">,</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">data_file_list</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fare_file_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&#34;../Data/NYC Trip Fare/&#34;</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;_&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">fare_file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;../Data/NYC Trip Fare/&#34;</span><span class="p">,</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">fare_file_list</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="mi">150000</span> <span class="c1"># Number of records per month chosen randomly </span>
</span></span><span class="line"><span class="cl"><span class="n">df_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">df_fare</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">zipped_data</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data_file_list</span><span class="p">,</span><span class="n">fare_file_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">fare_file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">zipped_data</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_file_list</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">df_data_sample</span><span class="p">,</span> <span class="n">df_fare_sample</span> <span class="o">=</span> <span class="n">df_sample</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="n">fare_file</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">df_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_data_sample</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df_fare</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_fare_sample</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fare</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_fare</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;medallion&#34;</span><span class="p">,</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fare</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;medallion&#34;</span><span class="p">,</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">final_df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fare</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;inner&#34;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;medallion&#34;</span><span class="p">,</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">final_df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">final_df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">final_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&#34;../Data/Pre-processed Data/data.csv&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The main sampling is conducted in the <code>df_sample</code> function which utilizes the reservoir sampling function itself. The main idea of reservoir sampling is explained <a href="https://en.wikipedia.org/wiki/Reservoir_sampling" target="_blank" rel="noopener noreffer">here</a> along with the pseudocode for its implementation. What we need to know is that it chooses a random sample (row) without replacement from the CSV file in a single pass over the whole file. Finally the fare and trip data are then joined together on the trips medallion and pickup datatime as they the represent the same trip just different data which gives us the final data to work with. It has about 2 million records (1.8M to be exact).</p>
<h2 id="data-cleaning">Data Cleaning</h2>
<p>In this phase of the project we&rsquo;ll check the data for any inconsistencies, outliers, erroneous values, etc. The cleaning itself is divided into several parts such as location data (pickup, dropoff) cleaning, trip duration cleaning, trip distance cleaning, trip speed cleaning, trip total amount, fare Amount, surcharge, tax, tolls and tip cleaning and categorical columns cleaning. We&rsquo;ll also use this phase to calculate and add some other features/columns as well. Let&rsquo;s get straight to it 😍!</p>
<h3 id="import-libraries-and-data-loading">Import Libraries and Data Loading</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">warnings</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">datetime</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">geopy.distance</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">folium</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">geopandas</span> <span class="kn">import</span> <span class="n">GeoDataFrame</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">geoplot</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&#34;display.max_columns&#34;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&#34;../Data/Pre-processed Data/data.csv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>medallion</th>
      <th>hack_license</th>
      <th>vendor_id</th>
      <th>rate_code</th>
      <th>store_and_fwd_flag</th>
      <th>pickup_datetime</th>
      <th>dropoff_datetime</th>
      <th>passenger_count</th>
      <th>trip_time_in_secs</th>
      <th>trip_distance</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>payment_type</th>
      <th>fare_amount</th>
      <th>surcharge</th>
      <th>mta_tax</th>
      <th>tip_amount</th>
      <th>tolls_amount</th>
      <th>total_amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>89D227B655E5C82AECF13C3F540D4CF4</td>
      <td>BA96DE419E711691B9445D6A6307C170</td>
      <td>CMT</td>
      <td>1</td>
      <td>N</td>
      <td>2013-01-01 15:11:48</td>
      <td>2013-01-01 15:18:10</td>
      <td>4</td>
      <td>382</td>
      <td>1.0</td>
      <td>-73.978165</td>
      <td>40.757977</td>
      <td>-73.989838</td>
      <td>40.751171</td>
      <td>CSH</td>
      <td>6.5</td>
      <td>0.0</td>
      <td>0.5</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0BD7C8F5BA12B88E0B67BED28BEA73D8</td>
      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>
      <td>CMT</td>
      <td>1</td>
      <td>N</td>
      <td>2013-01-06 00:18:35</td>
      <td>2013-01-06 00:22:54</td>
      <td>1</td>
      <td>259</td>
      <td>1.5</td>
      <td>-74.006683</td>
      <td>40.731781</td>
      <td>-73.994499</td>
      <td>40.750660</td>
      <td>CSH</td>
      <td>6.0</td>
      <td>0.5</td>
      <td>0.5</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>0BD7C8F5BA12B88E0B67BED28BEA73D8</td>
      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>
      <td>CMT</td>
      <td>1</td>
      <td>N</td>
      <td>2013-01-05 18:49:41</td>
      <td>2013-01-05 18:54:23</td>
      <td>1</td>
      <td>282</td>
      <td>1.1</td>
      <td>-74.004707</td>
      <td>40.737770</td>
      <td>-74.009834</td>
      <td>40.726002</td>
      <td>CSH</td>
      <td>5.5</td>
      <td>1.0</td>
      <td>0.5</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>DFD2202EE08F7A8DC9A57B02ACB81FE2</td>
      <td>51EE87E3205C985EF8431D850C786310</td>
      <td>CMT</td>
      <td>1</td>
      <td>N</td>
      <td>2013-01-07 23:54:15</td>
      <td>2013-01-07 23:58:20</td>
      <td>2</td>
      <td>244</td>
      <td>0.7</td>
      <td>-73.974602</td>
      <td>40.759945</td>
      <td>-73.984734</td>
      <td>40.759388</td>
      <td>CSH</td>
      <td>5.0</td>
      <td>0.5</td>
      <td>0.5</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>DFD2202EE08F7A8DC9A57B02ACB81FE2</td>
      <td>51EE87E3205C985EF8431D850C786310</td>
      <td>CMT</td>
      <td>1</td>
      <td>N</td>
      <td>2013-01-07 23:25:03</td>
      <td>2013-01-07 23:34:24</td>
      <td>1</td>
      <td>560</td>
      <td>2.1</td>
      <td>-73.976250</td>
      <td>40.748528</td>
      <td>-74.002586</td>
      <td>40.747868</td>
      <td>CSH</td>
      <td>9.5</td>
      <td>0.5</td>
      <td>0.5</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>10.5</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1799998 entries, 0 to 1799997
Data columns (total 22 columns):
 #   Column              Dtype  
---  ------              -----  
 0   Unnamed: 0          int64  
 1   medallion           object 
 2   hack_license        object 
 3   vendor_id           object 
 4   rate_code           int64  
 5   store_and_fwd_flag  object 
 6   pickup_datetime     object 
 7   dropoff_datetime    object 
 8   passenger_count     int64  
 9   trip_time_in_secs   int64  
 10  trip_distance       float64
 11  pickup_longitude    float64
 12  pickup_latitude     float64
 13  dropoff_longitude   float64
 14  dropoff_latitude    float64
 15  payment_type        object 
 16  fare_amount         float64
 17  surcharge           float64
 18  mta_tax             float64
 19  tip_amount          float64
 20  tolls_amount        float64
 21  total_amount        float64
dtypes: float64(11), int64(4), object(7)
memory usage: 302.1+ MB
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>rate_code</th>
      <th>passenger_count</th>
      <th>trip_time_in_secs</th>
      <th>trip_distance</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>fare_amount</th>
      <th>surcharge</th>
      <th>mta_tax</th>
      <th>tip_amount</th>
      <th>tolls_amount</th>
      <th>total_amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799930e+06</td>
      <td>1.799930e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
      <td>1.799998e+06</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>8.999985e+05</td>
      <td>1.035788e+00</td>
      <td>2.020107e+00</td>
      <td>7.653680e+02</td>
      <td>6.113157e+00</td>
      <td>-7.286966e+01</td>
      <td>4.013907e+01</td>
      <td>-7.280162e+01</td>
      <td>4.009319e+01</td>
      <td>1.243297e+01</td>
      <td>2.739124e-01</td>
      <td>4.982975e-01</td>
      <td>1.338854e+00</td>
      <td>2.654285e-01</td>
      <td>1.480971e+01</td>
    </tr>
    <tr>
      <th>std</th>
      <td>5.196148e+05</td>
      <td>2.800236e-01</td>
      <td>1.660724e+00</td>
      <td>1.153058e+04</td>
      <td>3.744392e+03</td>
      <td>9.001916e+00</td>
      <td>6.591034e+00</td>
      <td>9.397887e+00</td>
      <td>7.702412e+00</td>
      <td>4.701487e+01</td>
      <td>3.383309e-01</td>
      <td>2.912650e-02</td>
      <td>2.238275e+00</td>
      <td>1.239370e+00</td>
      <td>4.750405e+01</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>-9.885000e+01</td>
      <td>-3.114279e+03</td>
      <td>-1.145424e+03</td>
      <td>-3.113789e+03</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>4.499992e+05</td>
      <td>1.000000e+00</td>
      <td>1.000000e+00</td>
      <td>3.600000e+02</td>
      <td>1.080000e+00</td>
      <td>-7.399219e+01</td>
      <td>4.073427e+01</td>
      <td>-7.399150e+01</td>
      <td>4.073344e+01</td>
      <td>6.500000e+00</td>
      <td>0.000000e+00</td>
      <td>5.000000e-01</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>8.000000e+00</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>8.999985e+05</td>
      <td>1.000000e+00</td>
      <td>1.000000e+00</td>
      <td>6.000000e+02</td>
      <td>1.820000e+00</td>
      <td>-7.398193e+01</td>
      <td>4.075231e+01</td>
      <td>-7.398040e+01</td>
      <td>4.075279e+01</td>
      <td>9.500000e+00</td>
      <td>0.000000e+00</td>
      <td>5.000000e-01</td>
      <td>1.000000e+00</td>
      <td>0.000000e+00</td>
      <td>1.100000e+01</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.349998e+06</td>
      <td>1.000000e+00</td>
      <td>2.000000e+00</td>
      <td>9.600000e+02</td>
      <td>3.300000e+00</td>
      <td>-7.396665e+01</td>
      <td>4.076756e+01</td>
      <td>-7.396390e+01</td>
      <td>4.076763e+01</td>
      <td>1.400000e+01</td>
      <td>5.000000e-01</td>
      <td>5.000000e-01</td>
      <td>2.000000e+00</td>
      <td>0.000000e+00</td>
      <td>1.650000e+01</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.799997e+06</td>
      <td>9.000000e+00</td>
      <td>2.080000e+02</td>
      <td>4.293410e+06</td>
      <td>5.005073e+06</td>
      <td>4.082401e+01</td>
      <td>2.234990e+03</td>
      <td>1.428738e+03</td>
      <td>6.527231e+02</td>
      <td>6.155086e+04</td>
      <td>5.830000e+00</td>
      <td>5.000000e-01</td>
      <td>5.586200e+02</td>
      <td>9.713000e+01</td>
      <td>6.155303e+04</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Unnamed: 0                  0
medallion                   0
hack_license                0
vendor_id                   0
rate_code                   0
store_and_fwd_flag    1493331
pickup_datetime             0
dropoff_datetime            0
passenger_count             0
trip_time_in_secs           0
trip_distance               0
pickup_longitude            0
pickup_latitude             0
dropoff_longitude          68
dropoff_latitude           68
payment_type                0
fare_amount                 0
surcharge                   0
mta_tax                     0
tip_amount                  0
tolls_amount                0
total_amount                0
dtype: int64
</code></pre>
<p>After getting a quick overview of the data let&rsquo;s get into the actual cleaning</p>
<h3 id="convert-dates-to-datetime-type">Convert dates to datetime type</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="location-data-cleaning">Location Data Cleaning</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> \
</span></span><span class="line"><span class="cl"><span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> \
</span></span><span class="line"><span class="cl"><span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>-1145.4238 1428.7383
-3114.2788 2234.9895
</code></pre>
<p>We see some very unexpected and erroneous latitude and longitude (location) data, let&rsquo;s clean that up.</p>
<h4 id="trips-only-within-new-york-city">Trips only within New York City</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">NYBB</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">74.4505</span><span class="p">,</span> <span class="o">-</span><span class="mf">72.8478</span><span class="p">,</span> <span class="mf">40.2734</span><span class="p">,</span> <span class="mf">41.256</span><span class="p">)</span> <span class="c1"># https://boundingbox.klokantech.com/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size Before: </span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">&gt;=</span> <span class="n">NYBB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">&lt;=</span> <span class="n">NYBB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> \
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&gt;=</span> <span class="n">NYBB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&lt;=</span> <span class="n">NYBB</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> \
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">&gt;=</span> <span class="n">NYBB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">&lt;=</span> <span class="n">NYBB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> \
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">&gt;=</span> <span class="n">NYBB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">&lt;=</span> <span class="n">NYBB</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size After: </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed: </span><span class="si">{</span><span class="n">before</span> <span class="o">-</span> <span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Rows/Size Before: 1799998
Rows/Size After: 1770605
Removed: 29393
</code></pre>
<p>We remove 29393 incorrect location records.</p>
<h3 id="trip-dates-and-duration-cleaning">Trip Dates and Duration Cleaning</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count                      1770605
mean     0 days 00:12:17.623533763
std      0 days 00:11:57.343927277
min                0 days 00:00:00
25%                0 days 00:06:00
50%                0 days 00:10:00
75%                0 days 00:16:00
max                7 days 01:13:13
dtype: object
</code></pre>
<p>We&rsquo;re seeing weird trip durations of 7 days and 0 seconds here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size Before: </span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">invalid_trip_time_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_time_in_secs&#34;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">trip_time_in_secs_ser</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">invalid_trip_time_idx</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&#34;trip_time_in_secs&#34;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trip_time_in_secs_ser</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">invalid_trip_time_idx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">invalid_duration_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">())</span> <span class="o">|</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">invalid_duration_idx</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&#34;trip_time_in_secs&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">column</span><span class="o">=</span><span class="s2">&#34;trip_time_in_min&#34;</span><span class="p">,</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&#34;timedelta64[m]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size After: </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed: </span><span class="si">{</span><span class="n">before</span> <span class="o">-</span> <span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Rows/Size Before: 1770605
Rows/Size After: 1768663
Removed: 1942
</code></pre>
<p>Here we correct the invalid trip duration by calculating it from the pickup and dropoff datetime as well as remove the negative and trips with zero seconds. We do that using numpy&rsquo;s <code>np.where</code> to get all the rows where the duration is invalid and correct that in line 6. We finally add the trip duration in minutes as well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count                      1768663
mean     0 days 00:12:18.433447751
std      0 days 00:11:57.320887829
min                0 days 00:00:01
25%                0 days 00:06:00
50%                0 days 00:10:00
75%                0 days 00:16:00
max                7 days 01:13:13
dtype: object
</code></pre>
<p>We corrected the incorrect trip duration, removed the zero and negative duration trips but we still see very low trip durations of 1 second and very high trip duration of 7 days. We can inspect the percentiles of the trip duration distribution to get an idea where to cut the maximum and minimum values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">trip_duration_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_time_in_secs&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">trip_duration_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.00</span><span class="p">:</span><span class="mf">0.1</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>0.00      1.0
0.01    107.0
0.02    120.0
0.03    120.0
0.04    180.0
0.05    180.0
0.06    180.0
0.07    180.0
0.08    212.0
0.09    240.0
0.10    240.0
Name: trip_time_in_secs, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">trip_duration_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.90</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>0.90      1380.0
0.91      1440.0
0.92      1500.0
0.93      1560.0
0.94      1680.0
0.95      1740.0
0.96      1860.0
0.97      2040.0
0.98      2280.0
0.99      2700.0
1.00    609193.0
Name: trip_time_in_secs, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_short_duration</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    337.000000
mean       0.763501
std        3.118799
min        0.000000
25%        0.000000
50%        0.000000
75%        0.000000
max       31.700000
Name: trip_distance, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig_short</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_short_duration</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&#34;pickup_longitude&#34;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">&#34;pickup_latitude&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fig_short</span> <span class="o">=</span> <span class="n">fig_short</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span> <span class="mi">1</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Short Duration Pickups&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fig_short</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">showlegend</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">fig_short</span> <span class="o">=</span> <span class="n">fig_short</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_short_duration</span><span class="p">[</span><span class="s2">&#34;dropoff_longitude&#34;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">                         <span class="n">y</span><span class="o">=</span><span class="n">df_short_duration</span><span class="p">[</span><span class="s2">&#34;dropoff_latitude&#34;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&#34;red&#34;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Short Duration Dropoffs&#34;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">fig_short</span> <span class="o">=</span> <span class="n">fig_short</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Longitude&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Latitude&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig_short</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/fig1.html" height="525" width="100%"></iframe>
<p>We&rsquo;re seeing the outline of New York so these weird durations might just be problems with the meter, we&rsquo;ll drop them.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_large_duration</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">trip_time_in_secs</span> <span class="o">&gt;=</span> <span class="mi">43200</span><span class="p">)]</span> <span class="c1"># 12 hours max, See : https://www1.nyc.gov/assets/tlc/downloads/pdf/rule_book_current_chapter_58.pdf#page=34</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_large_duration</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count         3.000000
mean      96236.666667
std      166681.513487
min           0.200000
25%           3.050000
50%           5.900000
75%      144354.900000
max      288703.900000
Name: trip_distance, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size Before: </span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">invalid_duration_idx</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">trip_time_in_secs</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">trip_time_in_secs</span> <span class="o">&gt;=</span> <span class="mi">43200</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">invalid_duration_idx</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size After: </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed: </span><span class="si">{</span><span class="n">before</span> <span class="o">-</span> <span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Rows/Size Before: 1768663
Rows/Size After: 1768323
Removed: 340
</code></pre>
<p>340 records have been removed with erroneous trip durations.</p>
<h3 id="trip-distance-cleaning">Trip Distance Cleaning</h3>
<p>We follow the same percentile inspection procedure along with the describe function to check for outliers and invalid records.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1768323.00000
mean           6.02009
std         3771.53508
min            0.00000
25%            1.09000
50%            1.83000
75%            3.31000
max      5005073.00000
Name: trip_distance, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">trip_distance_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_distance&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">trip_distance_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.00</span><span class="p">:</span><span class="mf">0.1</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>0.00    0.00
0.01    0.24
0.02    0.38
0.03    0.44
0.04    0.50
0.05    0.53
0.06    0.58
0.07    0.60
0.08    0.64
0.09    0.68
0.10    0.70
Name: trip_distance, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">trip_distance_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.90</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>0.90          6.48
0.91          7.02
0.92          7.72
0.93          8.52
0.94          9.30
0.95         10.11
0.96         11.09
0.97         12.62
0.98         16.48
0.99         18.31
1.00    5005073.00
Name: trip_distance, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">500000</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span> <span class="s2">&#34;trip_distance&#34;</span><span class="p">)</span> <span class="c1">#obvious outliers (ran several times due to sampling)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/fig2.html" height="525" width="100%"></iframe>
<p>As the comment above states there are obvious outliers.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="c1"># Second smallest distance is 0.01 miles or 16 meters</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>0.01
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">500000</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>array([0.  , 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1 ,
       0.11, 0.12, 0.13, 0.14, 0.15, 0.16, 0.17, 0.18, 0.19, 0.2 , 0.21,
       0.22, 0.23, 0.24, 0.25, 0.26, 0.27, 0.28, 0.29, 0.3 , 0.31, 0.32,
       0.33, 0.34, 0.35, 0.36, 0.37, 0.38, 0.39, 0.4 , 0.41, 0.42, 0.43,
       0.44, 0.45, 0.46, 0.47, 0.48, 0.49, 0.5 , 0.51, 0.52, 0.53, 0.54,
       0.55, 0.56, 0.57, 0.58, 0.59, 0.6 , 0.61, 0.62, 0.63, 0.64, 0.65,
       0.66, 0.67, 0.68, 0.69, 0.7 , 0.71, 0.72, 0.73, 0.74, 0.75, 0.76,
       0.77, 0.78, 0.79, 0.8 , 0.81, 0.82, 0.83, 0.84, 0.85, 0.86, 0.87,
       0.88, 0.89, 0.9 , 0.91, 0.92, 0.93, 0.94, 0.95, 0.96, 0.97, 0.98,
       0.99, 1.  , 1.01, 1.02, 1.03, 1.04, 1.05, 1.06, 1.07, 1.08, 1.09,
       1.1 , 1.11, 1.12, 1.13, 1.14, 1.15, 1.16, 1.17])
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>1059974    5005073.0
1090317     318000.0
1085978      40005.0
1055761       1320.6
1167755        335.9
1125147        302.0
1055917        275.8
1134537        272.9
1166016        238.8
1095309        225.2
Name: trip_distance, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size Before: </span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">invalid_distance_idx</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># Remove distance of 0 and greater than 100 miles https://www.google.com/maps/dir/40.5055432,-74.2381798/41.0191685,-73.7871866/@40.9358817,-74.3487811,8.92z/data=!3m1!5s0x89c2f2be234865c9:0x12533050f3f45b3c!4m2!4m1!3e0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">invalid_distance_idx</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size After: </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed: </span><span class="si">{</span><span class="n">before</span> <span class="o">-</span> <span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Rows/Size Before: 1768323
Rows/Size After: 1765510
Removed: 2813
</code></pre>
<h3 id="trip-speed-cleaning">Trip Speed Cleaning</h3>
<p>Helps detect abnormal relationships between distance and time (combining the last 2 cleaning procedures)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&#34;trip_distance&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">column</span><span class="o">=</span><span class="s2">&#34;trip_distance_km&#34;</span><span class="p">,</span><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_distance&#34;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.609344</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&#34;trip_distance_km&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">column</span><span class="o">=</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">,</span><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_distance&#34;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_time_in_secs&#34;</span><span class="p">])</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1765510.00000
mean          13.79154
std           19.18644
min            0.03000
25%            9.12000
50%           12.28000
75%           16.50000
max         7280.00000
Name: trip_speed_mi/hr, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">speed_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">speed_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mf">0.1</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>0.00    0.030
0.01    2.864
0.02    4.045
0.03    4.665
0.04    5.115
0.05    5.480
0.06    5.800
0.07    6.076
0.08    6.327
0.09    6.560
0.10    6.771
Name: trip_speed_mi/hr, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">speed_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.90</span><span class="p">:]</span> <span class="c1"># very odd maxmimum speed</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>0.90      22.439
0.91      23.191
0.92      24.000
0.93      25.000
0.94      26.107
0.95      27.424
0.96      29.023
0.97      31.024
0.98      33.715
0.99      37.835
1.00    7280.000
Name: trip_speed_mi/hr, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>1455995    7280.000
1440280    7155.000
1150060    7069.091
1150552    6222.857
1143343    5811.429
1053937    5340.000
1374463    5130.000
1157752    4551.429
1173308    4385.455
1041760    4075.714
1459064    3894.545
1433255    3577.500
1458672    3570.000
1438038    3350.769
1058099    3305.455
1149133    3276.000
1374628    3120.000
1339895    3105.000
1439642    3067.200
1345988    2674.286
1374860    2595.000
1151062    2520.000
1094388    2487.273
1076385    2392.941
1094307    2310.000
1148658    2243.077
1150085    2243.077
1405731    2229.231
1344046    2160.000
1078396    2052.000
Name: trip_speed_mi/hr, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">speeds</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl"><span class="n">speeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">speeds</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2"> percentile is </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">99</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">speeds</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">speeds</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">99</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="p">)]))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;100 percentile value is &#34;</span><span class="p">,</span><span class="n">speeds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">del</span> <span class="n">speeds</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>99.0 percentile is 37.835
99.1 percentile is 38.4
99.2 percentile is 39.025
99.3 percentile is 39.729
99.4 percentile is 40.518
99.5 percentile is 41.4
99.6 percentile is 42.45
99.7 percentile is 43.722
99.8 percentile is 45.408
99.9 percentile is 48.027
100 percentile value is  7280.0
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size Before: </span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 99.9th percentile is 48.027</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size After: </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed: </span><span class="si">{</span><span class="n">before</span> <span class="o">-</span> <span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Rows/Size Before: 1765510
Rows/Size After: 1764465
Removed: 1045
</code></pre>
<h3 id="trip-total-amount-fare-amount-surcharge-tax-tolls-and-tip-cleaning">Trip Total Amount, Fare Amount, Surcharge, Tax, Tolls and Tip Cleaning</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1764465.00000
mean          14.66869
std           11.83378
min            0.00000
25%            8.00000
50%           11.00000
75%           16.50000
max          563.12000
Name: total_amount, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;fare_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1764465.00000
mean          12.30551
std            9.79532
min            0.00000
25%            6.50000
50%            9.50000
75%           14.00000
max          330.00000
Name: fare_amount, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;surcharge&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1764465.00000
mean           0.27433
std            0.33809
min            0.00000
25%            0.00000
50%            0.00000
75%            0.50000
max            5.83000
Name: surcharge, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;mta_tax&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1764465.00000
mean           0.49890
std            0.02340
min            0.00000
25%            0.50000
50%            0.50000
75%            0.50000
max            0.50000
Name: mta_tax, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1764465.00000
mean           1.32689
std            2.16548
min            0.00000
25%            0.00000
50%            1.00000
75%            2.00000
max          558.62000
Name: tip_amount, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;tolls_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1764465.00000
mean           0.26283
std            1.22958
min            0.00000
25%            0.00000
50%            0.00000
75%            0.00000
max           97.13000
Name: tolls_amount, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">total_amount_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">total_amount_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">total_amount_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.90</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>(0.00    0.00
 0.01    4.50
 0.02    4.50
 0.03    5.00
 0.04    5.00
 0.05    5.50
 0.06    5.50
 0.07    5.62
 0.08    6.00
 0.09    6.00
 0.10    6.00
 Name: total_amount, dtype: float64,
 0.90     26.50
 0.91     28.50
 0.92     30.50
 0.93     33.33
 0.94     36.12
 0.95     39.33
 0.96     43.03
 0.97     48.90
 0.98     57.83
 0.99     65.60
 1.00    563.12
 Name: total_amount, dtype: float64)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>1031853    0.0
1035254    0.0
1041181    0.0
1043898    0.0
1044443    0.0
1047473    0.0
1050744    0.0
1053522    0.0
1055058    0.0
1055089    0.0
1056811    0.0
1060794    0.0
1061535    0.0
1064759    0.0
1071199    0.0
1072267    0.0
1074670    0.0
1076662    0.0
1092351    0.0
1098501    0.0
Name: total_amount, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>1122353    563.12
1470048    330.00
1407367    325.00
1429526    300.60
1445864    300.00
685414     298.83
1291224    287.84
1255443    269.00
910977     267.60
74407      266.55
456863     261.75
1114236    260.00
632331     256.63
1555698    255.33
897057     254.50
1721477    254.23
1617697    252.00
1223427    250.63
1239784    250.00
1183020    249.00
Name: total_amount, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">totals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl"><span class="n">totals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">totals</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2"> percentile is </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">99</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">totals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">totals</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">99</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="p">)]))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;100 percentile value is &#34;</span><span class="p">,</span><span class="n">totals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">del</span> <span class="n">totals</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>99.0 percentile is 65.6
99.1 percentile is 67.7
99.2 percentile is 67.93
99.3 percentile is 68.23
99.4 percentile is 68.23
99.5 percentile is 69.38
99.6 percentile is 70.33
99.7 percentile is 72.28
99.8 percentile is 78.0
99.9 percentile is 91.66
100 percentile value is  563.12
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size Before: </span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">150</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># See: https://www.introducingnewyork.com/taxis</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size After: </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed: </span><span class="si">{</span><span class="n">before</span> <span class="o">-</span> <span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Rows/Size Before: 1764465
Rows/Size After: 1764321
Removed: 144
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fare_amount_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;fare_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">fare_amount_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">fare_amount_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.90</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>(0.00    0.0
 0.01    3.5
 0.02    4.0
 0.03    4.0
 0.04    4.0
 0.05    4.5
 0.06    4.5
 0.07    4.5
 0.08    5.0
 0.09    5.0
 0.10    5.0
 Name: fare_amount, dtype: float64,
 0.90     23.0
 0.91     24.0
 0.92     25.5
 0.93     27.5
 0.94     29.5
 0.95     32.0
 0.96     34.5
 0.97     40.0
 0.98     52.0
 0.99     52.0
 1.00    150.0
 Name: fare_amount, dtype: float64)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size Before: </span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;fare_amount&#34;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows/Size After: </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed: </span><span class="si">{</span><span class="n">before</span> <span class="o">-</span> <span class="n">after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Rows/Size Before: 1764321
Rows/Size After: 1764321
Removed: 0
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">surcharge_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;surcharge&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">surcharge_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">surcharge_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.9</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>(0.00    0.0
 0.01    0.0
 0.02    0.0
 0.03    0.0
 0.04    0.0
 0.05    0.0
 0.06    0.0
 0.07    0.0
 0.08    0.0
 0.09    0.0
 0.10    0.0
 Name: surcharge, dtype: float64,
 0.90    1.00
 0.91    1.00
 0.92    1.00
 0.93    1.00
 0.94    1.00
 0.95    1.00
 0.96    1.00
 0.97    1.00
 0.98    1.00
 0.99    1.00
 1.00    5.83
 Name: surcharge, dtype: float64)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">surcharge</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>1434721    5.83
1458665    2.50
1092410    2.00
1426960    2.00
1035864    1.50
1116033    1.50
1138106    1.50
1150637    1.50
1358139    1.50
1370980    1.50
Name: surcharge, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">mta_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;mta_tax&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">mta_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">mta_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.9</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>(0.00    0.0
 0.01    0.5
 0.02    0.5
 0.03    0.5
 0.04    0.5
 0.05    0.5
 0.06    0.5
 0.07    0.5
 0.08    0.5
 0.09    0.5
 0.10    0.5
 Name: mta_tax, dtype: float64,
 0.90    0.5
 0.91    0.5
 0.92    0.5
 0.93    0.5
 0.94    0.5
 0.95    0.5
 0.96    0.5
 0.97    0.5
 0.98    0.5
 0.99    0.5
 1.00    0.5
 Name: mta_tax, dtype: float64)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tip_amount_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_amount_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.0</span><span class="p">:</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">tip_amount_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.9</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>(0.00    0.0
 0.01    0.0
 0.02    0.0
 0.03    0.0
 0.04    0.0
 0.05    0.0
 0.06    0.0
 0.07    0.0
 0.08    0.0
 0.09    0.0
 0.10    0.0
 Name: tip_amount, dtype: float64,
 0.90      3.37
 0.91      3.60
 0.92      3.88
 0.93      4.10
 0.94      4.50
 0.95      5.00
 0.96      5.60
 0.97      6.40
 0.98      7.75
 0.99     10.40
 1.00    121.20
 Name: tip_amount, dtype: float64)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">tip_amount</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>1513550    121.20
600519     115.50
843787     111.00
1013173    111.00
466914     110.00
676289     110.00
909348     110.00
244908     100.33
408036     100.00
1255130     96.00
414779      93.71
1675505     91.00
655186      88.00
1279699     88.00
609128      87.94
60783       85.80
1549039     81.00
1321652     80.80
1214863     80.00
1697546     80.00
Name: tip_amount, dtype: float64
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tolls_percentiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;tolls_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span><span class="mi">2</span> <span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">tolls_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.0</span><span class="p">:</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">tolls_percentiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.9</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>(0.00    0.0
 0.01    0.0
 0.02    0.0
 0.03    0.0
 0.04    0.0
 0.05    0.0
 0.06    0.0
 0.07    0.0
 0.08    0.0
 0.09    0.0
 0.10    0.0
 Name: tolls_amount, dtype: float64,
 0.90     0.00
 0.91     0.00
 0.92     0.00
 0.93     0.00
 0.94     0.00
 0.95     0.00
 0.96     4.80
 0.97     5.33
 0.98     5.33
 0.99     5.33
 1.00    94.83
 Name: tolls_amount, dtype: float64)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">tolls_amount</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>1036970    94.83
1144668    90.31
1147141    62.26
1034771    53.49
1080876    53.01
1150660    48.69
1137765    34.39
1163542    28.00
1121143    21.32
1167016    20.91
Name: tolls_amount, dtype: float64
</code></pre>
<h3 id="passenger-count-cleaning">Passenger Count Cleaning</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s2">&#34;passenger_count&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="c1"># Looks clean but we have passenger counts of 0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>count    1764321.00000
mean           2.02239
std            1.65448
min            0.00000
25%            1.00000
50%            1.00000
75%            2.00000
max            6.00000
Name: passenger_count, dtype: object
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;passenger_count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#7 trips with passenger count 0, replace with mean value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;passenger_count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;passenger_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">passenger_count</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>7
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">passenger_count</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">0.9</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>0.90    5.0
0.91    5.0
0.92    5.0
0.93    5.0
0.94    6.0
0.95    6.0
0.96    6.0
0.97    6.0
0.98    6.0
0.99    6.0
1.00    6.0
Name: passenger_count, dtype: float64
</code></pre>
<h3 id="categorical-columns-cleaning">Categorical Columns Cleaning</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;number&#34;</span><span class="p">,</span><span class="s2">&#34;datetime&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span> <span class="c1">#rate code is missing as its numerical, but will be treated as categorical</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Index(['medallion', 'hack_license', 'vendor_id', 'store_and_fwd_flag',
       'payment_type'],
      dtype='object')
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">rate_code</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="c1"># Should only be 1,2,3,4,5,6 from data description, See: https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_yellow.pdf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>array([1, 2, 4, 3, 5, 6, 0], dtype=int64)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">allowed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">abnormal_rate_code</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">rate_code</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">allowed</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">abnormal_rate_code</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>33
</code></pre>
<p>We can use the <a href="https://python-visualization.github.io/folium/" target="_blank" rel="noopener noreffer">Folium</a> library to plot maps with markers and lines on it (and much more). We&rsquo;ll use it to inspect some of these (14) abnormal rate code (rate code = 0) trips</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">newyork_center</span><span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mf">40.7345</span><span class="p">,</span> <span class="o">-</span><span class="mf">73.8697</span><span class="p">])</span> <span class="c1"># https://www.google.com/search?q=middle+of+new+york+coordinates&amp;rlz=1C1CHBF_enDE1000DE1000&amp;oq=middle+of+new+york+coordina&amp;aqs=chrome.1.69i57j33i22i29i30l6.7294j0j7&amp;sourceid=chrome&amp;ie=UTF-8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">pickup_lat</span><span class="p">,</span><span class="n">pick_long</span><span class="p">,</span> <span class="n">dropoff_lat</span><span class="p">,</span> <span class="n">dropoff_long</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abnormal_rate_code</span><span class="p">[</span><span class="s2">&#34;pickup_latitude&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                                                 <span class="n">abnormal_rate_code</span><span class="p">[</span><span class="s2">&#34;pickup_longitude&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                                                 <span class="n">abnormal_rate_code</span><span class="p">[</span><span class="s2">&#34;dropoff_latitude&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                                                 <span class="n">abnormal_rate_code</span><span class="p">[</span><span class="s2">&#34;dropoff_longitude&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                                                 <span class="n">abnormal_rate_code</span><span class="p">[</span><span class="s2">&#34;rate_code&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">14</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">folium</span><span class="o">.</span><span class="n">CircleMarker</span><span class="p">([</span><span class="n">pickup_lat</span><span class="p">,</span> <span class="n">pick_long</span><span class="p">],</span><span class="n">popup</span><span class="o">=</span><span class="n">code</span><span class="p">,</span><span class="n">tooltip</span> <span class="o">=</span> <span class="s2">&#34;Pickup&#34;</span><span class="p">,</span><span class="n">fill_color</span><span class="o">=</span> <span class="s2">&#34;#d1005b&#34;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&#34;#d1005b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">radius</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">newyork_center</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  
</span></span><span class="line"><span class="cl">    <span class="n">folium</span><span class="o">.</span><span class="n">CircleMarker</span><span class="p">([</span><span class="n">dropoff_lat</span><span class="p">,</span> <span class="n">dropoff_long</span><span class="p">],</span><span class="n">popup</span><span class="o">=</span><span class="n">code</span><span class="p">,</span><span class="n">tooltip</span> <span class="o">=</span> <span class="s2">&#34;Dropoff&#34;</span><span class="p">,</span><span class="n">fill_color</span><span class="o">=</span> <span class="s2">&#34;#616161&#34;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&#34;#616161&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">radius</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">newyork_center</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">folium</span><span class="o">.</span><span class="n">PolyLine</span><span class="p">([[</span><span class="n">pickup_lat</span><span class="p">,</span> <span class="n">pick_long</span><span class="p">],[</span><span class="n">dropoff_lat</span><span class="p">,</span><span class="n">dropoff_long</span><span class="p">]])</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">newyork_center</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">newyork_center</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/abnormal_rate.html" height="525" width="100%"></iframe>
<p>They look normal trips, there are 33 so I&rsquo;ll replace them with rate code 1 i.e. standard rate</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">abnormal_rate_code_idx</span> <span class="o">=</span> <span class="n">abnormal_rate_code</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">abnormal_rate_code_idx</span><span class="p">,</span> <span class="s1">&#39;rate_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">payment_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="c1"># Looks fine CSH = Cash, DIS = Dispute, CRD = Credit Card, UNK = Unknown, NOC = No charge</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>array(['CSH', 'DIS', 'CRD', 'UNK', 'NOC'], dtype=object)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">store_and_fwd_flag</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="c1"># Looks fine Y= store and forward trip, N= not a store and forward trip</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>array(['N', 'Y', nan], dtype=object)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">vendor_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="c1"># Looks fine CMT = Creative Mobile Technologies, VTS = VeriFone Inc.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>array(['CMT', 'VTS'], dtype=object)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&#34;../Data/Pre-processed Data/cleaned_data.csv&#34;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>They all look as expected so we finally save our clean dataset and onto EDA!</p>
<h2 id="data-analysis">Data Analysis</h2>
<p>Exploratory Data Analysis is the process of studying data and extracting insights from it in order to examine its major properties. EDA may be accomplished through the use of statistics and graphical approaches (using my favourite plotting library Plotly! With a bit of matplotlib as well 😁). Why is it important? We simply can’t make sense of such huge datasets if we don’t explore the data. Exploratory Data Analysis helps us look deeper and see if our intuition matches with the data. It helps us see if we are asking the right questions. Exploring and analyzing the data is important to see how features are distributed or if and how they are related with each other. How they are contributing to the target variable (varable to be predicted/modelled), if there is any or simply analyzing the features without it. This will eventually help us answer the questions we have around the dataset, allow us to formulate new questions and check if we are even asking the right questions. So let&rsquo;s start as usual by importing and loading our the cleaned dataset.</p>
<h3 id="import-libraries-and-data-loading-1">Import Libraries and Data Loading</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">warnings</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">ss</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">statsmodels.distributions.empirical_distribution</span> <span class="kn">import</span> <span class="n">ECDF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">datetime</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">geopy.distance</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPoint</span><span class="p">,</span><span class="n">MultiPolygon</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">folium</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">folium.plugins</span> <span class="kn">import</span> <span class="n">HeatMapWithTime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">geopy.geocoders</span> <span class="kn">import</span> <span class="n">Nominatim</span>
</span></span><span class="line"><span class="cl"><span class="n">geolocator</span> <span class="o">=</span> <span class="n">Nominatim</span><span class="p">(</span><span class="n">user_agent</span><span class="o">=</span><span class="s2">&#34;taxi-analyis&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">geopandas</span> <span class="kn">import</span> <span class="n">GeoDataFrame</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">geoplot</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pygeohash</span> <span class="k">as</span> <span class="nn">pgh</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pyproj</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">area</span> <span class="kn">import</span> <span class="n">area</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">plotly.offline</span> <span class="k">as</span> <span class="nn">pyo</span>
</span></span><span class="line"><span class="cl"><span class="n">pyo</span><span class="o">.</span><span class="n">init_notebook_mode</span><span class="p">(</span><span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&#34;display.max_columns&#34;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&#34;../Data/Pre-processed Data/cleaned_data.csv&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="convert-dates-to-datetime">Convert dates to datetime</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Too many addresses to geocode, Nominatim usage policy doesn&#39;t allow bulk geocoding and will timeout (was going to be used in hover)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#df[&#34;pickup_address&#34;] = df.apply(lambda x: geolocator.reverse(str(x.pickup_latitude) + &#34;,&#34; + str(x.pickup_longitude),timeout=5)[0],axis=1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#df[&#34;dropoff_address&#34;] = df.apply(lambda x: geolocator.reverse(str(x.dropoff_latitude) + &#34;,&#34; + str(x.dropoff_longitude),timeout=5)[0],axis=1)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="splitting-data-for-test-and-train-sets">Splitting data for test and train sets</h3>
<p>Prevent exploration on test set (data-snooping)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_test</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">df_test</span><span class="o">.</span><span class="n">shape</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>((1182095, 24), (582226, 24))
</code></pre>
<p>We start by simply plotting a map of a sample (10,000) pickups and dropoffs to get a rough idea if there is a significant difference.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getBB</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">BB</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df_BB</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> 
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df_BB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">drop_pick_map</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="n">sample_size</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">df_plt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df_plt</span> <span class="o">=</span> <span class="n">getBB</span><span class="p">(</span><span class="n">df_plt</span><span class="p">,</span> <span class="n">BB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Scattermapbox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">lat</span><span class="o">=</span> <span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">]</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">lon</span><span class="o">=</span> <span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trip Distance (mi): &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;&lt;br&gt;&#34;</span> <span class="o">+</span> <span class="s1">&#39;Trip Speed (mi/hr): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_plt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertext</span><span class="o">=</span><span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">customdata</span> <span class="o">=</span> <span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">size</span><span class="o">=</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">opacity</span> <span class="o">=</span> <span class="n">opacity</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;Pickups&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">subplot</span><span class="o">=</span><span class="s1">&#39;mapbox&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&#34;Latitude (°): %</span><span class="si">{lat}</span><span class="s2"> &lt;br&gt;Longitude (°): %</span><span class="si">{lon}</span><span class="s2"> &lt;br&gt;Trip Duration (s): %</span><span class="si">{hovertext}</span><span class="s2"> &lt;br&gt;%</span><span class="si">{text}</span><span class="s2"> &lt;br&gt;Trip Amount ($): %</span><span class="si">{customdata}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">go</span><span class="o">.</span><span class="n">Scattermapbox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">lat</span><span class="o">=</span> <span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;dropoff_latitude&#39;</span><span class="p">]</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">lon</span><span class="o">=</span> <span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;dropoff_longitude&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trip Distance (mi): &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;&lt;br&gt;&#34;</span> <span class="o">+</span> <span class="s1">&#39;Trip Speed (mi/hr): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_plt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertext</span><span class="o">=</span><span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">customdata</span> <span class="o">=</span> <span class="n">df_plt</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">size</span><span class="o">=</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">opacity</span> <span class="o">=</span> <span class="n">opacity</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;Dropoffs&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">subplot</span> <span class="o">=</span><span class="s1">&#39;mapbox2&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&#34;Latitude (°): %</span><span class="si">{lat}</span><span class="s2"> &lt;br&gt;Longitude (°): %</span><span class="si">{lon}</span><span class="s2"> &lt;br&gt;Trip Duration (s): %</span><span class="si">{hovertext}</span><span class="s2"> &lt;br&gt;%</span><span class="si">{text}</span><span class="s2"> &lt;br&gt;Trip Amount ($): %</span><span class="si">{customdata}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">mapbox</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">center</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lat</span><span class="o">=</span><span class="mf">40.721319</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lon</span><span class="o">=-</span><span class="mf">73.987130</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;open-street-map&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">zoom</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">domain</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}),</span>
</span></span><span class="line"><span class="cl">                       <span class="n">mapbox2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">center</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lat</span><span class="o">=</span><span class="mf">40.721319</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lon</span><span class="o">=-</span><span class="mf">73.987130</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;open-street-map&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">zoom</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">domain</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.51</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#All hires computationaly expensive, can&#39;t use interactive plots opting from matplotlib</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">all_hires</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df_sub</span> <span class="o">=</span> <span class="n">getBB</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">BB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_sub</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">,</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_sub</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="p">,</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&#34;Pickups&#34;</span><span class="p">,</span><span class="s2">&#34;Dropoffs&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NYBB</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">74.15</span><span class="p">,</span> <span class="o">-</span><span class="mf">73.7004</span><span class="p">,</span> <span class="mf">40.5774</span><span class="p">,</span> <span class="mf">40.9176</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">drop_pick_map</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">NYBB</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Map of Pickups &amp; Dropoffs&#39;</span><span class="p">,</span><span class="n">sample_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/pick_drop.html" height="525" width="100%"></iframe>
<p>We see a slight difference where the pickups are more on the West of New York in the Manhattan area but the dropoffs are more to the East of New York in the Queens and Brooklyn area.</p>
<p>We can also see all the pickups and dropoffs in one graphic below</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">all_hires</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span><span class="n">NYBB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/all hires.png" width="100%">
<p>We&rsquo;ll segment the EDA sections by question and we&rsquo;ll start with our first question</p>
<h3 id="q1-how-much-do-taxis-earn-per-trip-if-they-can-only-drive-30km-or-50km-per-trip-compared-to-taxis-that-have-no-limit-ie-what-is-the-average-income-for-trips-30km-or-50km-compared-to-the-total-revenue">Q1: How much do taxis earn per trip if they can only drive 30km or 50km per trip, compared to taxis that have no limit? (i.e. what is the average income for trips &lt;30km or &lt;50km compared to the total revenue?)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">,</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">,</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">correlation_amount</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cor</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">correlation_amount</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cor</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_amount</span><span class="p">,</span><span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.4f&#39;</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;fontsize&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;Tip Amount&#39;</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Trip Distance&#39;</span><span class="p">,</span><span class="s1">&#39;Trip Speed&#39;</span><span class="p">,</span> <span class="s1">&#39;Trip Duration&#39;</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;Total Amount&#39;</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Correlation Matrix between Total Amount and Numerical Features&#34;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/Amount Correlation.jpeg" height= "525px" width="100%">
<p>Total Amount is highly positively correlated with the trip distance (0.94) and trip duration (0.83)</p>
<p>Significant Difference between Trips less than 5km and all trips, no significant difference from the other restrictions, this is mainly due to the fact that &lt;30km and &lt;50km capture most trips
We can also see the difference below in the box plots and histograms</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_30_less</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_distance_km&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_50_less</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_distance_km&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#more severe</span>
</span></span><span class="line"><span class="cl"><span class="n">df_5_less</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_distance_km&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Mean Total Amount for 30 km or less: &#34;</span><span class="p">,</span> <span class="n">df_30_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Mean Total Amount for 50 km or less: &#34;</span><span class="p">,</span> <span class="n">df_50_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Mean Total Amount for 5 km or less: &#34;</span><span class="p">,</span> <span class="n">df_5_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Mean Total Amount for no distance restriction: &#34;</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Mean Total Amount for 30 km or less:  14.223142284432392
Mean Total Amount for 50 km or less:  14.645665338921816
Mean Total Amount for 5 km or less:  9.734024318446
Mean Total Amount for no distance restriction:  14.6549403897318
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_30_less</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span> <span class="s2">&#34;30 km or less earnings distribution&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_50_less</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span> <span class="s2">&#34;50 km or less earnings distribution&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_5_less</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span> <span class="s2">&#34;5 km or less earnings distribution&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&#34;total_amount&#34;</span><span class="p">],</span><span class="n">name</span><span class="o">=</span> <span class="s2">&#34;No distance limit earnings distribution&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;T1: How much do taxis earn per trip according to distance restrictions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="s2">&#34;../Figures/T1/T1_fig.html&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/Boxplot Amount.png" width="100%">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">all_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">km30_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_30_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">km50_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_50_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Log Distribution of Total Amount&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_log</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">all_log</span><span class="p">)],</span><span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No restriction&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">km30_log</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">km30_log</span><span class="p">)],</span><span class="n">bins</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;30 km or less&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">km50_log</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">km50_log</span><span class="p">)],</span><span class="n">bins</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;50 km or less&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/Log Distribution of Total Amount.png" width="100%">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Distribution of Total Amount&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No restriction&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_30_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;30 km or less&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_50_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;50 km or less&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/Distribution of Total Amount.png" width="100%">
<p>Kolmogorov–Smirnov Test is used to test for the significance in the difference between the distributions and again same results are observed analytically</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ks_30vs_all</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">ks_2samp</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_30_less</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ks_50vs_all</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">ks_2samp</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_50_less</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ks_5vs_all</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">ks_2samp</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_5_less</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;KS-Statistics between 30 km restriction and no restriction: </span><span class="si">{</span><span class="n">ks_30vs_all</span><span class="o">.</span><span class="n">statistic</span><span class="si">}</span><span class="s2">, p-value: </span><span class="si">{</span><span class="n">ks_30vs_all</span><span class="o">.</span><span class="n">pvalue</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;KS-Statistics between 50 km restriction and no restriction: </span><span class="si">{</span><span class="n">ks_50vs_all</span><span class="o">.</span><span class="n">statistic</span><span class="si">}</span><span class="s2">, p-value: </span><span class="si">{</span><span class="n">ks_50vs_all</span><span class="o">.</span><span class="n">pvalue</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;KS-Statistics between 5 km restriction and no restriction: </span><span class="si">{</span><span class="n">ks_5vs_all</span><span class="o">.</span><span class="n">statistic</span><span class="si">}</span><span class="s2">, p-value: </span><span class="si">{</span><span class="n">ks_5vs_all</span><span class="o">.</span><span class="n">pvalue</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>KS-Statistics between 30 km restriction and no restriction: 
0.008042675652436548, p-value: 1.6896187294453e-33

KS-Statistics between 50 km restriction and no restriction: 
0.00011191457137738059, p-value: 1.0

KS-Statistics between 5 km restriction and no restriction: 
0.23128162369336924, p-value: 0.0
</code></pre>
<p>The Kolmogorov–Smirnov Test is based on the cumulative distribution so we will look at that</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ecdf_norestrict</span> <span class="o">=</span> <span class="n">ECDF</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ecdf_30</span> <span class="o">=</span> <span class="n">ECDF</span><span class="p">(</span><span class="n">df_30_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ecdf_50</span> <span class="o">=</span> <span class="n">ECDF</span><span class="p">(</span><span class="n">df_50_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ecdf_5</span> <span class="o">=</span> <span class="n">ECDF</span><span class="p">(</span><span class="n">df_5_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ecdf_norestrict</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ecdf_norestrict</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Restriction&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ecdf_30</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ecdf_30</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;30 km or less&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ecdf_50</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ecdf_50</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;50 km or less&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ecdf_5</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ecdf_5</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;5 km or less&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Total Amount&#39;</span><span class="p">,</span><span class="n">fontdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">_</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">,</span><span class="n">fontdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/Cumulative Distribution of Total Amount.png" width="100%">
<p>Another metric we can use to quanitfy the difference in the distributions is the Wasserstein Distance, which we inspect below visually and analytically</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">wassersteindist_plot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">a_cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_values</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_values</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&#34;F&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">b_cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_values</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">b</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_values</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&#34;F&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">all_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">all_values</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">all_values</span><span class="p">,</span> <span class="n">a_cdf</span><span class="p">,</span> <span class="n">b_cdf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">cdf_30</span> <span class="o">=</span> <span class="n">wassersteindist_plot</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_30_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">cdf_50</span> <span class="o">=</span> <span class="n">wassersteindist_plot</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_50_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">cdf_5</span> <span class="o">=</span> <span class="n">wassersteindist_plot</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_5_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;No Restrict&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_30</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;30 km or less&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">cdf_30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&#34;grey&#34;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;Wasserstein</span><span class="se">\n</span><span class="s2">distance&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Total Amount&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&#34;lower right&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/SWD30.png" width="100%">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;No Restrict&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;50 km or less&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">cdf_50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&#34;grey&#34;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;Wasserstein</span><span class="se">\n</span><span class="s2">distance&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Total Amount&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&#34;lower right&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/SWD50.png" width="100%">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;No Restrict&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;5 km or less&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">cdf_all</span><span class="p">,</span> <span class="n">cdf_5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&#34;grey&#34;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;Wasserstein</span><span class="se">\n</span><span class="s2">distance&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Total Amount&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&#34;lower right&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/SWD5.png" width="100%">
<p>Again from the wasserstein distance plots we see the same result, no significant difference (low wasserstein distance) between trips of less than 30 or 50km and all trips, but the opposite (high wasserstein distance) between trips of less than 5km and all trips.</p>
<p>We&rsquo;ll also look at the standerdized wasserstein distance</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">standardized_wasserstein_distance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&#34;std&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">numerator</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">wasserstein_distance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">concat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">concat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;minmax&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">concat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">concat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">denominator</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">concat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">concat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">concat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">concat</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">denominator</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">concat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">concat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">concat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">concat</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;iqr&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">concat</span><span class="p">,</span> <span class="p">[</span><span class="mf">.25</span><span class="p">,</span> <span class="mf">.75</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span> <span class="k">if</span> <span class="n">denominator</span> <span class="o">!=</span> <span class="mf">.0</span> <span class="k">else</span> <span class="mf">.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;SWD (mean method) between No Restriction and 30 km or less: </span><span class="si">{</span><span class="n">standardized_wasserstein_distance</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_30_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;SWD (mean method) between No Restriction and 50 km or less: </span><span class="si">{</span><span class="n">standardized_wasserstein_distance</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_50_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;SWD (mean method) between No Restriction and 5 km or less: </span><span class="si">{</span><span class="n">standardized_wasserstein_distance</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_5_less</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>SWD (mean method) between No Restriction and 30 km or less: 
0.0031855750868686784

SWD (mean method) between No Restriction and 50 km or less: 
6.868595381679189e-05

SWD (mean method) between No Restriction and 5 km or less: 
0.035809828654724
</code></pre>
<p>Trip Distance matters!</p>
<p>Obviously as we have seen severe restrictions on distance affect the total trip amount and as seen in the correlation chart above, the trip distance is highly positevely correlated with the total amount</p>
<h3 id="q2-do-more-taxi-trips-start-at-the-north-or-south">Q2: Do more taxi trips start at the North or South?</h3>
<p>By taking a arbitrary north and south cutoff we get these results</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">south</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&lt;</span> <span class="mf">40.66240321639479</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">north</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&gt;</span> <span class="mf">40.803265534217225</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Number of trips starting in the south: &#34;</span><span class="p">,</span><span class="n">south</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Number of trips starting in the north: &#34;</span><span class="p">,</span><span class="n">north</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Number of trips starting in the south:  21708
Number of trips starting in the north:  19359
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Scattermapbox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">lat</span><span class="o">=</span> <span class="n">south</span><span class="p">[</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">]</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">lon</span><span class="o">=</span> <span class="n">south</span><span class="p">[</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trip Distance (mi): &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">south</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;&lt;br&gt;&#34;</span> <span class="o">+</span> <span class="s1">&#39;Trip Speed (mi/hr): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">south</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">south</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertext</span><span class="o">=</span><span class="n">south</span><span class="p">[</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">customdata</span> <span class="o">=</span> <span class="n">south</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">size</span><span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;South Pickups&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">subplot</span><span class="o">=</span><span class="s1">&#39;mapbox&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&#34;Latitude (°): %</span><span class="si">{lat}</span><span class="s2"> &lt;br&gt;Longitude (°): %</span><span class="si">{lon}</span><span class="s2"> &lt;br&gt;Trip Duration (s): %</span><span class="si">{hovertext}</span><span class="s2"> &lt;br&gt;%</span><span class="si">{text}</span><span class="s2"> &lt;br&gt;Trip Amount ($): %</span><span class="si">{customdata}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">go</span><span class="o">.</span><span class="n">Scattermapbox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">lat</span><span class="o">=</span> <span class="n">north</span><span class="p">[</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">]</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">lon</span><span class="o">=</span> <span class="n">north</span><span class="p">[</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trip Distance (mi): &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">north</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;&lt;br&gt;&#34;</span> <span class="o">+</span> <span class="s1">&#39;Trip Speed (mi/hr): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">north</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">north</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertext</span><span class="o">=</span><span class="n">north</span><span class="p">[</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">customdata</span> <span class="o">=</span> <span class="n">north</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">size</span><span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;North Pickups&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&#34;Latitude (°): %</span><span class="si">{lat}</span><span class="s2"> &lt;br&gt;Longitude (°): %</span><span class="si">{lon}</span><span class="s2"> &lt;br&gt;Trip Duration (s): %</span><span class="si">{hovertext}</span><span class="s2"> &lt;br&gt;%</span><span class="si">{text}</span><span class="s2"> &lt;br&gt;Trip Amount ($): %</span><span class="si">{customdata}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">mapbox</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">center</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lat</span><span class="o">=</span><span class="mf">40.721319</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lon</span><span class="o">=-</span><span class="mf">73.987130</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;open-street-map&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">zoom</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">domain</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;South vs North Pickups&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/cutoff.html" height="525" width="100%"></iframe>
<p>By taking the center of Manhatten as a cutoff we get a more intutive answer</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">south2</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&lt;</span> <span class="mf">40.78035634806236</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">north2</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&gt;</span> <span class="mf">40.78035634806236</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Number of trips starting in the south: &#34;</span><span class="p">,</span><span class="n">south2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Number of trips starting in the north: &#34;</span><span class="p">,</span><span class="n">north2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Number of trips starting in the south:  1062763
Number of trips starting in the north:  119332
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Scattermapbox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">lat</span><span class="o">=</span> <span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">][</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">]</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">lon</span><span class="o">=</span> <span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">][</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trip Distance (mi): &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">][</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;&lt;br&gt;&#34;</span> <span class="o">+</span> <span class="s1">&#39;Trip Speed (mi/hr): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">][</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertext</span><span class="o">=</span><span class="n">south</span><span class="p">[</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">customdata</span> <span class="o">=</span> <span class="n">south</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">size</span><span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;South Pickups&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">subplot</span><span class="o">=</span><span class="s1">&#39;mapbox&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&#34;Latitude (°): %</span><span class="si">{lat}</span><span class="s2"> &lt;br&gt;Longitude (°): %</span><span class="si">{lon}</span><span class="s2"> &lt;br&gt;Trip Duration (s): %</span><span class="si">{hovertext}</span><span class="s2"> &lt;br&gt;%</span><span class="si">{text}</span><span class="s2"> &lt;br&gt;Trip Amount ($): %</span><span class="si">{customdata}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">go</span><span class="o">.</span><span class="n">Scattermapbox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">lat</span><span class="o">=</span> <span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">][</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">]</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">lon</span><span class="o">=</span> <span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">][</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trip Distance (mi): &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">][</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;&lt;br&gt;&#34;</span> <span class="o">+</span> <span class="s1">&#39;Trip Speed (mi/hr): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">][</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertext</span><span class="o">=</span><span class="n">north</span><span class="p">[</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">customdata</span> <span class="o">=</span> <span class="n">north</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">size</span><span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;North Pickups&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&#34;Latitude (°): %</span><span class="si">{lat}</span><span class="s2"> &lt;br&gt;Longitude (°): %</span><span class="si">{lon}</span><span class="s2"> &lt;br&gt;Trip Duration (s): %</span><span class="si">{hovertext}</span><span class="s2"> &lt;br&gt;%</span><span class="si">{text}</span><span class="s2"> &lt;br&gt;Trip Amount ($): %</span><span class="si">{customdata}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">mapbox</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">center</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lat</span><span class="o">=</span><span class="mf">40.721319</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lon</span><span class="o">=-</span><span class="mf">73.987130</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;open-street-map&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">zoom</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">domain</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;South vs North Pickups&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/center.html" height="525" width="100%"></iframe>
<p>Some trips are in water! These will be removed and numbers checked again (should have been done in the cleaning phase but these weren&rsquo;t detected until now)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">BB</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">74.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">72.8</span><span class="p">,</span> <span class="mf">40.5</span><span class="p">,</span> <span class="mf">41.8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">nyc_water</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;water_mask.png&#39;</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="c1"># Mask </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getXY</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">BB</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">xdim</span> <span class="o">*</span> <span class="p">(</span><span class="n">lon</span> <span class="o">-</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">ydim</span> <span class="o">-</span> <span class="n">ydim</span> <span class="o">*</span> <span class="p">(</span><span class="n">lat</span> <span class="o">-</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">before</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Rows before bounding box&#34;</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[(</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> 
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Rows after bounding box&#34;</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pickup_x</span><span class="p">,</span> <span class="n">pickup_y</span> <span class="o">=</span> <span class="n">getXY</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">nyc_water</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nyc_water</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dropoff_x</span><span class="p">,</span> <span class="n">dropoff_y</span> <span class="o">=</span> <span class="n">getXY</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="p">,</span> <span class="n">nyc_water</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nyc_water</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">land_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">nyc_water</span><span class="p">[</span><span class="n">pickup_y</span><span class="p">,</span> <span class="n">pickup_x</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">nyc_water</span><span class="p">[</span><span class="n">dropoff_y</span><span class="p">,</span> <span class="n">dropoff_x</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">land_idx</span><span class="p">)</span><span class="si">}</span><span class="s2"> Trips in water!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Rows before water trips removal&#34;</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">land_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">after</span><span class="o">=</span><span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Rows after water trips removal&#34;</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Total removed: &#34;</span><span class="p">,</span><span class="n">before</span> <span class="o">-</span> <span class="n">after</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Rows before bounding box 1182095
Rows after bounding box 1182079
49 Trips in water!
Rows before water trips removal 1182079
Rows after water trips removal 1182030
Total removed:  65
</code></pre>
<p>I removed the trips in water by loading in a mask (shown below) that was created using GIMP and following this <a href="https://www.fsdeveloper.com/forum/attachments/using-gimp-to-create-water-mask-pdf.39106/" target="_blank" rel="noopener noreffer">tutorial</a> from an image of New York.</p>
<figure>
  <img src="/posts/New-York-Taxi-Analysis/NYC.png" alt="New York"/>
  <figcaption style = "font-size:15px">Map of NYC</figcaption>
</figure>
<figure>
  <img src="/posts/New-York-Taxi-Analysis/water_mask.png" alt="New York"/>
  <figcaption style = "font-size:15px">Water Mask of NYC</figcaption>
</figure>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">south2</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&lt;</span> <span class="mf">40.78035634806236</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">north2</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&gt;</span> <span class="mf">40.78035634806236</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Number of trips starting in the south after water removal: &#34;</span><span class="p">,</span><span class="n">south2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Number of trips starting in the north after water removal: &#34;</span><span class="p">,</span><span class="n">north2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Number of trips starting in the south after water removal:  1062702
Number of trips starting in the north after water removal:  119328
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Scattermapbox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">lat</span><span class="o">=</span> <span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">][</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">]</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">lon</span><span class="o">=</span> <span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">][</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trip Distance (mi): &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">][</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;&lt;br&gt;&#34;</span> <span class="o">+</span> <span class="s1">&#39;Trip Speed (mi/hr): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">][</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">south2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150000</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertext</span><span class="o">=</span><span class="n">south</span><span class="p">[</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">customdata</span> <span class="o">=</span> <span class="n">south2</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">size</span><span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;South Pickups&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">subplot</span><span class="o">=</span><span class="s1">&#39;mapbox&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&#34;Latitude (°): %</span><span class="si">{lat}</span><span class="s2"> &lt;br&gt;Longitude (°): %</span><span class="si">{lon}</span><span class="s2"> &lt;br&gt;Trip Duration (s): %</span><span class="si">{hovertext}</span><span class="s2"> &lt;br&gt;%</span><span class="si">{text}</span><span class="s2"> &lt;br&gt;Trip Amount ($): %</span><span class="si">{customdata}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">go</span><span class="o">.</span><span class="n">Scattermapbox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">lat</span><span class="o">=</span> <span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">][</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">]</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">lon</span><span class="o">=</span> <span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">][</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trip Distance (mi): &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">][</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;&lt;br&gt;&#34;</span> <span class="o">+</span> <span class="s1">&#39;Trip Speed (mi/hr): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">][</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">north2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50000</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertext</span><span class="o">=</span><span class="n">north</span><span class="p">[</span><span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">customdata</span> <span class="o">=</span> <span class="n">north</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">size</span><span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;North Pickups&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&#34;Latitude (°): %</span><span class="si">{lat}</span><span class="s2"> &lt;br&gt;Longitude (°): %</span><span class="si">{lon}</span><span class="s2"> &lt;br&gt;Trip Duration (s): %</span><span class="si">{hovertext}</span><span class="s2"> &lt;br&gt;%</span><span class="si">{text}</span><span class="s2"> &lt;br&gt;Trip Amount ($): %</span><span class="si">{customdata}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">mapbox</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">center</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lat</span><span class="o">=</span><span class="mf">40.721319</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">lon</span><span class="o">=-</span><span class="mf">73.987130</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;open-street-map&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">zoom</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">domain</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;South vs North Pickups&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/correct_center.html" height="525" width="100%"></iframe>
<p>We see there are no longer data points on the water. And that there are more trips starting at the South of New York.</p>
<p>We&rsquo;ll now add more features that are required for later analysis</p>
<h3 id="adding-date-features">Adding date features</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_time_of_day</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">time</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Morning&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">time</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Afternon&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">time</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Evening&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">time</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">time</span> <span class="o">&lt;=</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Night&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">time</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">time</span> <span class="o">&lt;=</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Late night&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_hour&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_hour&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_week_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_week_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_month_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_month_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s2">&#34;pickup_time_of_day&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_time_of_day</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s2">&#34;dropoff_time_of_day&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&#34;dropoff_datetime&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_time_of_day</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="adding-direction-feature">Adding direction feature</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_direction</span><span class="p">(</span><span class="n">pickup_coords</span><span class="p">,</span> <span class="n">dropoff_coords</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_bearing</span><span class="p">(</span><span class="n">pickup_coords</span><span class="p">,</span> <span class="n">dropoff_coords</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">lat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">pickup_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">lat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dropoff_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">diffLong</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dropoff_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pickup_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">diffLong</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">diffLong</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">initial_bearing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">initial_bearing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">initial_bearing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">compass_bearing</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_bearing</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">compass_bearing</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;↑ N&#39;</span><span class="p">,</span> <span class="s1">&#39;↗ NE&#39;</span><span class="p">,</span> <span class="s1">&#39;→ E&#39;</span><span class="p">,</span> <span class="s1">&#39;↘ SE&#39;</span><span class="p">,</span> <span class="s1">&#39;↓ S&#39;</span><span class="p">,</span> <span class="s1">&#39;↙ SW&#39;</span><span class="p">,</span> <span class="s1">&#39;← W&#39;</span><span class="p">,</span> <span class="s1">&#39;↖ NW&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">bearing</span> <span class="o">=</span> <span class="n">get_bearing</span><span class="p">(</span><span class="n">pickup_coords</span><span class="p">,</span> <span class="n">dropoff_coords</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">bearing</span> <span class="o">/</span> <span class="mi">45</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">directions</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s2">&#34;trip_direction&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_direction</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                                                    <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can get the trip direction in terms of compass bearing using the above formula.</p>
<h3 id="q3-traffic-speed-analysis">Q3: Traffic Speed Analysis</h3>
<ul>
<li>Provide information about the average speed of traffic in New York
Analyze of the traffic speed changes in New York throughout the day</li>
<li>Analyze of the traffic speed changes in New York throughout the day</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Average overall taxi speed in New York in 2013: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> miles per hour or </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.609</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> km per hour&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Maximum taxi speed in New York in 2013: </span><span class="si">{</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2"> miles per hour or </span><span class="si">{</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.609</span><span class="si">}</span><span class="s2"> km per hour&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Minimum taxi speed in New York in 2013: </span><span class="si">{</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> miles per hour or </span><span class="si">{</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.609</span><span class="si">}</span><span class="s2"> km per hour&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Average overall taxi speed in New York in 2013: 
13.66 miles per hour or 21.99 km per hour

Maximum taxi speed in New York in 2013: 
50.0 miles per hour or 80.45 km per hour

Minimum taxi speed in New York in 2013: 
0.03 miles per hour or 0.04827 km per hour
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig_speed</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">,</span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Histogram of Trip Speeds&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fig_speed</span> <span class="o">=</span> <span class="n">fig_speed</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Trip Speed&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span> <span class="s1">&#39;Count&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig_speed_pdf</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">,</span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;PDF of Trip Speeds&#39;</span><span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability density&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fig_speed_pdf</span> <span class="o">=</span> <span class="n">fig_speed_pdf</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Trip Speed&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span> <span class="s1">&#39;Probability Density&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Data skewed to the right, this is usually a result of a lower boundary in a data set </span>
</span></span><span class="line"><span class="cl"><span class="c1"># So if the dataset&#39;s lower bounds are extremely low relative to the rest of the data, this will cause the data to skew right.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig_speed</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/Speed.html" height="525" width="100%"></iframe>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">table</span> <span class="o">=</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Right Skewed Distribution which means mean &gt; median &gt; mode&#34;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">([</span><span class="n">table</span><span class="p">],</span><span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;Speed Mean&#34;</span><span class="p">,</span><span class="s2">&#34;Speed Median&#34;</span><span class="p">,</span><span class="s2">&#34;Speed Mode&#34;</span><span class="p">]))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Right Skewed Distribution which means mean &gt; median &gt; mode

Speed Mean    Speed Median    Speed Mode
------------  --------------  ------------
 13.6649          12.275            12
</code></pre>
<h4 id="trip-speed-per-hour-of-day">Trip Speed Per Hour of Day</h4>
<p>We&rsquo;ll inspect the trip speed per hour of the day next</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pispeed_per_hourofday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">drspeed_per_hourofday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_hour&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_hour</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_hour</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pispeed_per_hourofday</span><span class="o">.</span><span class="n">pickup_hour</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">pispeed_per_hourofday</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Pickup Speed per hour&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_hour</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drspeed_per_hourofday</span><span class="o">.</span><span class="n">dropoff_hour</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drspeed_per_hourofday</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Dropoff Speed per hour&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_hour</span> <span class="o">=</span> <span class="n">speed_hour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Trip Speed Per Hour of Day&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Average Trip Speed&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Hour of Day&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_hour</span> <span class="o">=</span> <span class="n">speed_hour</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_hour</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/speed_hour.html" height="525" width="100%"></iframe>
<p>We see 5 AM being the fastest hour on average, as expected it is early in the morning and traffic is at its lowest. We also see that the slowest time on average is 9AM.</p>
<h4 id="trip-speed-per-day-of-week">Trip Speed Per Day of Week</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Avergae speed distribution per day</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Monday&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;Tuesday&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;Wednesday&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;Thursday&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;Friday&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;Saturday&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;Sunday&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">pispeed_per_day</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">pispeed_per_day</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">drspeed_per_day</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">drspeed_per_day</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_day</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_day</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pispeed_per_day</span><span class="o">.</span><span class="n">pickup_day</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">pispeed_per_day</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Pickup Speed per day&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_day</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drspeed_per_day</span><span class="o">.</span><span class="n">dropoff_day</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drspeed_per_day</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Dropoff Speed per day&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_day</span> <span class="o">=</span> <span class="n">speed_day</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Trip Speed Per Day&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Average Trip Speed&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Day&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_day</span> <span class="o">=</span> <span class="n">speed_day</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_day</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/speed_day.html" height="525" width="100%"></iframe>
<p>Sunday is the fastest day, which is a bit unusual as a lot of people usually go out on Sundays due to it being a holiday but maybe in New York it&rsquo;s the opposite and people stay inside. Friday is the slowest day of the week.</p>
<h4 id="trip-speed-per-both-hour-of-day-and-day-of-week">Trip Speed per both Hour of Day and Day of Week</h4>
<p>Going more granular with both day and time will allow us to see if this changes our findings and that there are combinations that weren&rsquo;t discovered.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Monday&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;Tuesday&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;Wednesday&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;Thursday&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;Friday&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;Saturday&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;Sunday&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">pispeed_per_dayhour</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">,</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">pispeed_per_dayhour</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">,</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pispeed_per_dayhour</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">,</span><span class="n">facet_row</span><span class="o">=</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;stack&#39;</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">facet_row_spacing</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Monday Mean Speed&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Tuesday&#39;</span><span class="p">][</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Tuesday Mean Speed&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Wednesday&#39;</span><span class="p">][</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Wednesday Mean Speed&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Thursday&#39;</span><span class="p">][</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Thursday Mean Speed&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Friday&#39;</span><span class="p">][</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Friday Mean Speed&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">][</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Saturday Mean Speed&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">][</span><span class="s2">&#34;trip_speed_mi/hr&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Sunday Mean Speed&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span> <span class="o">=</span> <span class="n">speed_dayhour</span><span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span> <span class="o">=</span> <span class="n">speed_dayhour</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Hour&#34;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">speed_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="o">==</span> <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">YAxis</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">speed_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="o">==</span> <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">XAxis</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">speed_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span> <span class="o">=</span> <span class="n">speed_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">                            <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mf">0.07</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Average Trip Speed&#34;</span><span class="p">,</span><span class="n">textangle</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">xref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">,</span><span class="n">yref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span> <span class="o">=</span> <span class="n">speed_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">                            <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Hour&#34;</span><span class="p">,</span><span class="n">xref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">,</span><span class="n">yref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span> <span class="o">=</span> <span class="n">speed_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_title</span> <span class="o">=</span> <span class="s1">&#39;Day&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_dayhour</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/speed_dayhour.html" height="525" width="100%"></iframe>
<p>Again we see on average 4 and 5AM are the fastest for all the days but we also see that compared to the other days Sunday has a higher speed at 11PM on average.</p>
<h4 id="traffic-speed-per-time-of-day">Traffic Speed per Time of Day</h4>
<p>We increase the granularity further by binning the hours into different time of day</p>
<ul>
<li>Morning is from 6AM to 11:59PM</li>
<li>Afternoon is from 12PM to 3:59PM</li>
<li>Evening is from 4PM to 9:59PM</li>
<li>Night is from 10PM to 12:59AM</li>
<li>Late Night is from 1AM to 5:59AM</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Average speed distribution per time of day</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pispeed_per_tday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;pickup_time_of_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">drspeed_per_tday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_time_of_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_tday</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_tday</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pispeed_per_tday</span><span class="o">.</span><span class="n">pickup_time_of_day</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">pispeed_per_tday</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Pickup Speed per Time of Day&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_tday</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drspeed_per_tday</span><span class="o">.</span><span class="n">dropoff_time_of_day</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drspeed_per_tday</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Dropoff Speed per Time of Day&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_tday</span> <span class="o">=</span> <span class="n">speed_tday</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Trip Speed Per Time of Day&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Average Trip Speed&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Time of Day&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_tday</span> <span class="o">=</span> <span class="n">speed_tday</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_tday</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/speed_tday.html" height="525" width="100%"></iframe>
<p>Late night is intuitively the fastest time and afernoon the slowest.</p>
<h4 id="traffic-speed-per-month">Traffic Speed per Month</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Average speed distribution per month</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;January&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;February&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;March&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;April&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;May&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;June&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;July&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="s2">&#34;August&#34;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s2">&#34;September&#34;</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&#34;October&#34;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;November&#34;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">&#34;December&#34;</span><span class="p">:</span><span class="mi">12</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">pispeed_per_month</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;pickup_month&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">pispeed_per_month</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;pickup_month&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">drspeed_per_month</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_month&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">drspeed_per_month</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;dropoff_month&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_month</span><span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_month</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pispeed_per_month</span><span class="o">.</span><span class="n">pickup_month</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">pispeed_per_month</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Pickup Speed per Month&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_month</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drspeed_per_month</span><span class="o">.</span><span class="n">dropoff_month</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drspeed_per_month</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Dropoff Speed per Month&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_month</span> <span class="o">=</span> <span class="n">speed_month</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Trip Speed Per Month&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Trip Speed&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Month&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_month</span> <span class="o">=</span> <span class="n">speed_month</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_month</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/speed_month.html" height="525" width="100%"></iframe>
<h4 id="traffic-speed-per-direction-of-trip">Traffic Speed per Direction of Trip</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Average speed distribution per direction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_per_dir</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;trip_direction&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_dir</span><span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dir</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">speed_per_dir</span><span class="o">.</span><span class="n">trip_direction</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">speed_per_dir</span><span class="p">[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Speed per Direction&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">speed_dir</span> <span class="o">=</span> <span class="n">speed_dir</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Trip Speed Per Direction&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Trip Speed&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Direction&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dir</span> <span class="o">=</span> <span class="n">speed_dir</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">speed_dir</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/speed_dir.html" height="525" width="100%"></iframe>
<h4 id="adding-borough-information">Adding borough information</h4>
<p>I have added the pickup and dropoff boroughs to be used in the analysis as well. I have also tried to add the pickup and dropoff neighbourhood (using New Yorks around 200 neighborhoods), for more granularity but this deemed to be highly computationaly expensive.</p>
<p>Adding the borough information can be seen as a challenging task at first but thanks to the <a href="https://shapely.readthedocs.io/en/stable/manual.html" target="_blank" rel="noopener noreffer">Shapley</a> library and to the New York boroughs geojson file found <a href="https://github.com/dwillis/nyc-maps" target="_blank" rel="noopener noreffer">here</a> it is possible to calculate where the trip started and ended like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">borough_nyc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;https://raw.githubusercontent.com/dwillis/nyc-maps/master/boroughs.geojson&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">boroughs</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">borough_nyc</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;BoroName&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">code</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;BoroCode&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">boroughs</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;polygon&#39;</span><span class="p">:</span><span class="n">MultiPolygon</span><span class="p">(</span><span class="n">polygons</span><span class="o">=</span><span class="n">polygons</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">boroughs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">boroughs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_borough</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">boro</span> <span class="o">=</span> <span class="s1">&#39;Outside Boroughs&#39;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">boroughs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;polygon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">boro</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">boro</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">trip_borough_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_train</span><span class="p">[[</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">,</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_latitude&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_longitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">trip_borough_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">get_borough</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                              <span class="n">get_borough</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dropoff_latitude&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dropoff_longitude&#39;</span><span class="p">])))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">df_boroughs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trip_borough_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;pickup_borough&#34;</span><span class="p">,</span><span class="s2">&#34;dropoff_borough&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">df_boroughs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_train</span><span class="p">,</span><span class="n">df_boroughs</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&#34;../Data/Pre-processed Data/cleaned_data2.csv&#34;</span><span class="p">)</span> <span class="c1">#Saving for future use</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can then use this information for analyzing the traffic speed, traffic density and much more.</p>
<h4 id="traffic-speed-between-new-york-city-boroughs">Traffic Speed between New York City Boroughs</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">avg_speed_boroughs</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;pickup_borough&#34;</span><span class="p">,</span><span class="s2">&#34;dropoff_borough&#34;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_speed_boroughs_img</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">avg_speed_boroughs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;pickup_borough&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">avg_speed_boroughs_fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">avg_speed_boroughs_img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">avg_speed_boroughs_img</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;No Trips&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">avg_speed_boroughs_fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">font</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">avg_speed_boroughs_fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">font</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_speed_boroughs_fig</span> <span class="o">=</span> <span class="n">avg_speed_boroughs_fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Average Trip Speed between Borough&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                              <span class="n">xaxis_title</span> <span class="o">=</span> <span class="s1">&#39;Dropoff Borough&#39;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s1">&#39;Pickup Borough&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">avg_speed_boroughs_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/avg_speed_boroughs_fig.html" height="525" width="100%"></iframe>
<p>We can see that Trips from Queens to Staten Island are the fastest on average (wth a whopping 37 miles per hour) while trips from Staten Island to Manhattan are the slowest on average along with trips from the Outskirts to Staten Island.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_pretty</span><span class="p">(</span><span class="n">styler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">styler</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&#34;Borough Average Speed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">styler</span><span class="o">.</span><span class="n">background_gradient</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&#34;plasma&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">styler</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_speed</span> <span class="o">=</span>  <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;pickup_borough&#39;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;trip_speed_mi/hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">borough_speed</span><span class="o">.</span><span class="n">columns</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Borough&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Speed&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">borough_speed</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&#34;Average Speed&#34;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">borough_speed</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">make_pretty</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><style type="text/css">
#T_46bff_row0_col1 {
  background-color: #fca338;
  color: #000000;
}
#T_46bff_row1_col1 {
  background-color: #ec7754;
  color: #f1f1f1;
}
#T_46bff_row2_col1 {
  background-color: #d14e72;
  color: #f1f1f1;
}
#T_46bff_row3_col1 {
  background-color: #cc4977;
  color: #f1f1f1;
}
#T_46bff_row4_col1 {
  background-color: #c33d80;
  color: #f1f1f1;
}
#T_46bff_row5_col1 {
  background-color: #b42e8d;
  color: #f1f1f1;
}
</style>
<table id="T_46bff">
  <caption>Borough Average Speed</caption>
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_46bff_level0_col0" class="col_heading level0 col0" >Borough</th>
      <th id="T_46bff_level0_col1" class="col_heading level0 col1" >Average Speed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_46bff_level0_row0" class="row_heading level0 row0" >4</th>
      <td id="T_46bff_row0_col0" class="data row0 col0" >Queens</td>
      <td id="T_46bff_row0_col1" class="data row0 col1" >23.922178</td>
    </tr>
    <tr>
      <th id="T_46bff_level0_row1" class="row_heading level0 row1" >5</th>
      <td id="T_46bff_row1_col0" class="data row1 col0" >Staten Island</td>
      <td id="T_46bff_row1_col1" class="data row1 col1" >20.205111</td>
    </tr>
    <tr>
      <th id="T_46bff_level0_row2" class="row_heading level0 row2" >0</th>
      <td id="T_46bff_row2_col0" class="data row2 col0" >Bronx</td>
      <td id="T_46bff_row2_col1" class="data row2 col1" >16.200803</td>
    </tr>
    <tr>
      <th id="T_46bff_level0_row3" class="row_heading level0 row3" >1</th>
      <td id="T_46bff_row3_col0" class="data row3 col0" >Brooklyn</td>
      <td id="T_46bff_row3_col1" class="data row3 col1" >15.686250</td>
    </tr>
    <tr>
      <th id="T_46bff_level0_row4" class="row_heading level0 row4" >3</th>
      <td id="T_46bff_row4_col0" class="data row4 col0" >Outside Boroughs</td>
      <td id="T_46bff_row4_col1" class="data row4 col1" >14.567957</td>
    </tr>
    <tr>
      <th id="T_46bff_level0_row5" class="row_heading level0 row5" >2</th>
      <td id="T_46bff_row5_col0" class="data row5 col0" >Manhattan</td>
      <td id="T_46bff_row5_col1" class="data row5 col1" >12.998500</td>
    </tr>
  </tbody>
</table>
<h3 id="q4-traffic-volume-analysis">Q4: Traffic Volume Analysis</h3>
<h4 id="traffic-volume-per-hour-of-day">Traffic Volume Per Hour of Day</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">traffic_density_pihour</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">traffic_density_drhour</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_hour&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_hour</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">density_hour</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">traffic_density_pihour</span><span class="o">.</span><span class="n">pickup_hour</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">traffic_density_pihour</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pickup Density per hour&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">density_hour</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">traffic_density_drhour</span><span class="o">.</span><span class="n">dropoff_hour</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">traffic_density_drhour</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dropoff Density per hour&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_hour</span> <span class="o">=</span> <span class="n">density_hour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Taxi traffic Density Per Hour&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Hour&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                          <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Number of trips&#34;</span><span class="p">,</span><span class="n">bargap</span> <span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">bargroupgap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_hour</span> <span class="o">=</span> <span class="n">density_hour</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span><span class="n">categoryorder</span> <span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span><span class="n">categoryarray</span> <span class="o">=</span> <span class="n">traffic_density_pihour</span><span class="o">.</span><span class="n">pickup_hour</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">density_hour</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/density_hour.html" height="525" width="100%"></iframe>
<p>Mornings and Evening are the busiest times.</p>
<h4 id="traffic-volume-per-day-of-week">Traffic Volume Per Day of Week</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Average speed distribution per day</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Monday&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;Tuesday&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;Wednesday&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;Thursday&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;Friday&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;Saturday&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;Sunday&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">traffic_density_piday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">traffic_density_piday</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">traffic_density_drday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">traffic_density_drday</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_day</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">density_day</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">traffic_density_piday</span><span class="o">.</span><span class="n">pickup_day</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">traffic_density_piday</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pickup Density per Day&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">density_day</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">traffic_density_drday</span><span class="o">.</span><span class="n">dropoff_day</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">traffic_density_drday</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dropoff Density per Day&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                      
</span></span><span class="line"><span class="cl"><span class="n">density_day</span> <span class="o">=</span> <span class="n">density_day</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Taxi traffic Density Per Day&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Day&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                          <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Number of trips&#34;</span><span class="p">,</span><span class="n">bargap</span> <span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">bargroupgap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_day</span> <span class="o">=</span> <span class="n">density_day</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_day</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/density_day.html" height="525" width="100%"></iframe>
<h4 id="traffic-volume-per-both-hour-of-day-and-day-of-week">Traffic Volume per both Hour of Day and Day of Week</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Monday&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;Tuesday&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;Wednesday&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;Thursday&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;Friday&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;Saturday&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;Sunday&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">density_per_dayhour</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">,</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">density_per_dayhour</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">,</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">density_per_dayhour</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">&#34;size&#34;</span><span class="p">,</span><span class="n">facet_row</span><span class="o">=</span><span class="s2">&#34;pickup_day&#34;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;pickup_day&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;stack&#39;</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">facet_row_spacing</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">density_per_dayhour</span><span class="p">[</span><span class="n">density_per_dayhour</span><span class="o">.</span><span class="n">pickup_day</span> <span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Monday Mean Density&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">density_per_dayhour</span><span class="p">[</span><span class="n">density_per_dayhour</span><span class="o">.</span><span class="n">pickup_day</span> <span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Tuesday Mean Density&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">density_per_dayhour</span><span class="p">[</span><span class="n">density_per_dayhour</span><span class="o">.</span><span class="n">pickup_day</span> <span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Wednesday Mean Density&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">density_per_dayhour</span><span class="p">[</span><span class="n">density_per_dayhour</span><span class="o">.</span><span class="n">pickup_day</span> <span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Thursday Mean Density&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">density_per_dayhour</span><span class="p">[</span><span class="n">density_per_dayhour</span><span class="o">.</span><span class="n">pickup_day</span> <span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Friday Mean Density&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">density_per_dayhour</span><span class="p">[</span><span class="n">density_per_dayhour</span><span class="o">.</span><span class="n">pickup_day</span> <span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Saturday Mean Density&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">density_per_dayhour</span><span class="p">[</span><span class="n">density_per_dayhour</span><span class="o">.</span><span class="n">pickup_day</span> <span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Sunday Mean Density&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span> <span class="o">=</span> <span class="n">density_dayhour</span><span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span> <span class="o">=</span> <span class="n">density_dayhour</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Hour&#34;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">density_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">density_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="o">==</span> <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">YAxis</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">density_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">density_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="o">==</span> <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">XAxis</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">density_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span> <span class="o">=</span> <span class="n">density_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">density_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">                            <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mf">0.07</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Number of Trips&#34;</span><span class="p">,</span><span class="n">textangle</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">xref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">,</span><span class="n">yref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span> <span class="o">=</span> <span class="n">density_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">density_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">                            <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Hour&#34;</span><span class="p">,</span><span class="n">xref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">,</span><span class="n">yref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span> <span class="o">=</span> <span class="n">density_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_title</span> <span class="o">=</span> <span class="s1">&#39;Day&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_dayhour</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/density_dayhour.html" height="525" width="100%"></iframe>
<p>The exceptions regarding traffic volume mentioned previously are conceptualised in this graph. Friday and Saturday night are the busiest for days, while the afternoon is the busiest for Sunday.</p>
<h4 id="traffic-volume-per-time-of-day">Traffic Volume per Time of Day</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">densitypi_per_tday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;pickup_time_of_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">densitydr_per_tday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_time_of_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_tday</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">density_tday</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">densitypi_per_tday</span><span class="o">.</span><span class="n">pickup_time_of_day</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">densitypi_per_tday</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pickup Density per Time of Day&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">density_tday</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">densitydr_per_tday</span><span class="o">.</span><span class="n">dropoff_time_of_day</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">densitydr_per_tday</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dropoff Density per Time of Day&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_tday</span> <span class="o">=</span> <span class="n">density_tday</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Density Per Time of Day&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Time of Day&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Number of Trips&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_tday</span> <span class="o">=</span> <span class="n">density_tday</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_tday</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/density_tday.html" height="525" width="100%"></iframe>
<h4 id="traffic-volume-per-month">Traffic Volume per Month</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;January&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;February&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;March&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;April&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;May&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;June&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;July&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="s2">&#34;August&#34;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s2">&#34;September&#34;</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&#34;October&#34;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;November&#34;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">&#34;December&#34;</span><span class="p">:</span><span class="mi">12</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">densitypi_per_month</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;pickup_month&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">densitypi_per_month</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;pickup_month&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">densitydr_per_month</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_month&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">densitydr_per_month</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;dropoff_month&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_month</span><span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">density_month</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">densitypi_per_month</span><span class="o">.</span><span class="n">pickup_month</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">densitypi_per_month</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pickup Density per Month&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">density_month</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">densitydr_per_month</span><span class="o">.</span><span class="n">dropoff_month</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">densitydr_per_month</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dropoff Density per Month&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_month</span> <span class="o">=</span> <span class="n">density_month</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Density Per Month&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Month&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Number of Trips&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_month</span> <span class="o">=</span> <span class="n">density_month</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span><span class="n">categoryorder</span> <span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span><span class="n">categoryarray</span> <span class="o">=</span> <span class="n">densitypi_per_month</span><span class="o">.</span><span class="n">pickup_month</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">density_month</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/density_month.html" height="525" width="100%"></iframe>
<p>As expected due to our sampling (150K per month) we get a uniform distribution for the months.</p>
<h4 id="traffic-volume-per-direction-of-trip">Traffic Volume per Direction of Trip</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">density_per_dir</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;trip_direction&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_dir</span><span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dir</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">density_per_dir</span><span class="o">.</span><span class="n">trip_direction</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">density_per_dir</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Density per Direction&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_dir</span> <span class="o">=</span> <span class="n">density_dir</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Density Per Direction&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Trip Direction&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Number of Trips&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dir</span> <span class="o">=</span> <span class="n">density_dir</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">density_dir</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/density_dir.html" height="525" width="100%"></iframe>
<h4 id="traffic-volume-between-nyc-boroughs">Traffic Volume between NYC Boroughs</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">density_boroughs</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;pickup_borough&#34;</span><span class="p">,</span><span class="s2">&#34;dropoff_borough&#34;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">density_boroughs_img</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">density_boroughs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;pickup_borough&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39;size&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_boroughs_fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">density_boroughs_img</span><span class="p">,</span><span class="n">color_continuous_scale</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">Agsunset_r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">density_boroughs_img</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;No Trips&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">density_boroughs_fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">font</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">family</span><span class="o">=</span><span class="s1">&#39;Open Sans&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">density_boroughs_fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">font</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">family</span><span class="o">=</span><span class="s1">&#39;Open Sans&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">density_boroughs_fig</span> <span class="o">=</span> <span class="n">density_boroughs_fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Density between Borough&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                              <span class="n">xaxis_title</span> <span class="o">=</span> <span class="s1">&#39;Dropoff Borough&#39;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s1">&#39;Pickup Borough&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">density_boroughs_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/density_boroughs_fig.html" height="525" width="100%"></iframe>
<p>Looking at the trips between boroughs we see that trips within Manhattan dominate, while trips from Manhattan to Brooklyn and Queens and Queens to Manhattan are also high. Only 1 trip between Staten Island and Queens, Brooklyn and Manhattan.</p>
<h4 id="traffic-density-per-borough-and-area">Traffic Density per Borough and Area</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">borough_area</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">boroughs</span> <span class="o">=</span> <span class="n">borough_nyc</span><span class="p">[</span><span class="s2">&#34;features&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">boroughs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&#34;properties&#34;</span><span class="p">][</span><span class="s2">&#34;BoroName&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">area</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">&#34;geometry&#34;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">1609</span><span class="o">*</span><span class="mi">1609</span><span class="p">)</span> <span class="c1"># converts from m^2 to mi^2</span>
</span></span><span class="line"><span class="cl">    <span class="n">borough_area</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pidensity_borough</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;pickup_borough&#34;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">pidensity_borough</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidensity_borough</span><span class="o">.</span><span class="n">pickup_borough</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">borough_area</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pidensity_borough</span><span class="p">[</span><span class="s1">&#39;density_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidensity_borough</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">pidensity_borough</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">drdensity_borough</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;dropoff_borough&#34;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">drdensity_borough</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drdensity_borough</span><span class="o">.</span><span class="n">dropoff_borough</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">borough_area</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">drdensity_borough</span><span class="p">[</span><span class="s1">&#39;density_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drdensity_borough</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">drdensity_borough</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pidensity_borough</span><span class="p">[</span><span class="s1">&#39;pickup_borough&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">pidensity_borough</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pickup Borough Traffic Density&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drdensity_borough</span><span class="p">[</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">drdensity_borough</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dropoff Borough Traffic Density&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density</span> <span class="o">=</span> <span class="n">borough_density</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Borough Traffic Density&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                         <span class="n">xaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Borough&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Density&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/borough_density.html" height="525" width="100%"></iframe>
<p>Brooklyn has more dropoffs than pickups</p>
<p>Strategic positioning to meet the demand to Brooklyn can be beneficial</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">borough_density_area</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density_area</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pidensity_borough</span><span class="p">[</span><span class="s1">&#39;pickup_borough&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">pidensity_borough</span><span class="p">[</span><span class="s1">&#39;density_area&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pickup Borough Traffic Density per Area&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density_area</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drdensity_borough</span><span class="p">[</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">drdensity_borough</span><span class="p">[</span><span class="s1">&#39;density_area&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dropoff Borough Traffic Density per Area&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density_area</span> <span class="o">=</span> <span class="n">borough_density_area</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Borough Traffic Density per Area&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                         <span class="n">xaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Borough&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Density/Area&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">borough_density_area</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/borough_density_area.html" height="525" width="100%"></iframe>
<p>Queens is by far the largest borough so we see here that Brooklyn is slightly higher on Traffic Density Per Area</p>
<p>We can also animate the traffic volume changes throughout the day using the Folium library as below, but the file is too big to publish below is a screen recording of how it looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_density_animation</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[[</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">,</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_latitude&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_longitude&#39;</span><span class="p">,</span><span class="s1">&#39;pickup_hour&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="s1">&#39;dropoff_hour&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">pickup_coords_per_hour</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span><span class="o">=</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_density_animation</span><span class="p">[</span><span class="n">df_density_animation</span><span class="p">[</span><span class="s1">&#39;pickup_hour&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">    <span class="n">pickup_coords_per_hour</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dropoff_coords_per_hour</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span><span class="o">=</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_density_animation</span><span class="p">[</span><span class="n">df_density_animation</span><span class="p">[</span><span class="s1">&#39;dropoff_hour&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dropoff_latitude&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dropoff_longitude&#39;</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">    <span class="n">dropoff_coords_per_hour</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">density_hourmap</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mf">40.70977</span><span class="p">,</span><span class="o">-</span><span class="mf">74.016609</span><span class="p">],</span><span class="n">zoom_start</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Hour = &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">HeatMapWithTime</span><span class="p">(</span><span class="n">pickup_coords_per_hour</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">auto_play</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="s1">&#39;bottomright&#39;</span><span class="p">,</span><span class="n">index</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Pickup Traffic Volume&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">density_hourmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">HeatMapWithTime</span><span class="p">(</span><span class="n">dropoff_coords_per_hour</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">auto_play</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="s1">&#39;bottomright&#39;</span><span class="p">,</span><span class="n">index</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Dropoff Traffic Volume&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">density_hourmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">folium</span><span class="o">.</span><span class="n">LayerControl</span><span class="p">()</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">density_hourmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">density_hourmap</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><video width="100%" controls>
  <source src="/posts/New-York-Taxi-Analysis/heatmap.mp4" type="video/mp4">
</video>
<p>We notice the same patterns as well in that most pickups are focused in the Manhattan area and that Dropoffs are more spread out to Queens, Brooklyn and JFK Airport</p>
<p>I have also animated the traffic volume per day and hour as well to get a more granular look but again its file is way too big to publish here, but the code to reproduce it can be found in my GitHub repo linked above.</p>
<h4 id="traffic-density-throughout-the-year">Traffic Density Throughout the Year</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_datetime&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">date_time_density</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;pickup_hour&#39;</span><span class="p">,</span><span class="n">df_train</span><span class="o">.</span><span class="n">pickup_datetime</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">date_time_density</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;pickup_datetime&#34;</span><span class="p">,</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">date_time_density_img</span> <span class="o">=</span> <span class="n">date_time_density</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;pickup_datetime&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s2">&#34;pickup_hour&#34;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span> <span class="s2">&#34;size&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">date_time_density_img</span> <span class="o">=</span> <span class="n">date_time_density_img</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">traffic_datehour</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">date_time_density_img</span><span class="p">,</span><span class="n">color_continuous_scale</span><span class="o">=</span><span class="s1">&#39;OrRd&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">traffic_datehour</span> <span class="o">=</span> <span class="n">traffic_datehour</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">traffic_datehour</span> <span class="o">=</span> <span class="n">traffic_datehour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span> <span class="s2">&#34;Pickup Density 2013&#34;</span><span class="p">,</span><span class="n">xaxis_title</span><span class="o">=</span> <span class="s2">&#34;Date&#34;</span><span class="p">,</span><span class="n">yaxis_title</span><span class="o">=</span> <span class="s2">&#34;Hour&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">highlighted_dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2013-02-01&#39;</span><span class="p">,</span><span class="s1">&#39;2013-02-08&#39;</span><span class="p">,</span><span class="s1">&#39;2013-07-04&#39;</span><span class="p">,</span><span class="s1">&#39;2013-09-13&#39;</span><span class="p">,</span><span class="s1">&#39;2013-12-25&#39;</span><span class="p">,</span><span class="s1">&#39;2013-12-31&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">highlighted_hours</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">22</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">text</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;b&gt;New York Knicks Final&lt;/b&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;b&gt;Weather Storm&lt;/b&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;b&gt;4th of July&lt;/b&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;b&gt;New York Yankees Final&lt;/b&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;b&gt;Christmas&lt;/b&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;&lt;b&gt;New Years Eve&lt;/b&gt;&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">text</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">highlighted_dates</span><span class="p">,</span> <span class="n">highlighted_hours</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">traffic_datehour</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span><span class="n">showarrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">arrowhead</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="n">arrowwidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">xshift</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">traffic_datehour</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/traffic_datehour.html" height="525" width="100%"></iframe>
<p>Looking at the whole year we can see the traffic volumne pattern on specific dates</p>
<h3 id="q4-tip-analysis">Q4: Tip Analysis</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig_tip</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">,</span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Histogram of Tip Amount&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fig_tip</span> <span class="o">=</span> <span class="n">fig_tip</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Tip Amount&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span> <span class="s1">&#39;Count&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig_tip</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/fig_tip.html" height="525" width="100%"></iframe>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">table</span> <span class="o">=</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Right Skewed Distribution which means mean &gt; median &gt; mode&#34;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">([</span><span class="n">table</span><span class="p">],</span><span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;Tip Amount Mean&#34;</span><span class="p">,</span><span class="s2">&#34;Tip Amount Median&#34;</span><span class="p">,</span><span class="s2">&#34;Tip Amount Mode&#34;</span><span class="p">]))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Right Skewed Distribution which means mean &gt; median &gt; mode

Tip Amount Mean    Tip Amount Median    Tip Amount Mode
-----------------  -------------------  -----------------
      1.32447                    1                  0
</code></pre>
<p>We see that most people don&rsquo;t tip.</p>
<h4 id="tip-per-hour-of-day">Tip per Hour of Day</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tip_per_hourofday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_hour&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_hour</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_hour</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tip_per_hourofday</span><span class="o">.</span><span class="n">dropoff_hour</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">tip_per_hourofday</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Tip Amount per hour&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_hour</span> <span class="o">=</span> <span class="n">tip_hour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount Per Hour of Day&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Hour of Day&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_hour</span> <span class="o">=</span> <span class="n">tip_hour</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_hour</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/tip_hour.html" height="525" width="100%"></iframe>
<h4 id="tip-per-day-of-week">Tip per Day of Week</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Monday&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;Tuesday&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;Wednesday&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;Thursday&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;Friday&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;Saturday&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;Sunday&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_day</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_day</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_day</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_day</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tip_per_day</span><span class="o">.</span><span class="n">dropoff_day</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">tip_per_day</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Tip Amount per day&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_day</span> <span class="o">=</span> <span class="n">tip_day</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount Per Day&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Day&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_day</span> <span class="o">=</span> <span class="n">tip_day</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_day</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/tip_day.html" height="525" width="100%"></iframe>
<h4 id="tip-per-hour-of-day-and-day-of-week">Tip per Hour of Day and Day of Week</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Monday&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;Tuesday&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;Wednesday&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;Thursday&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;Friday&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;Saturday&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;Sunday&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_dayhour</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">,</span><span class="s2">&#34;dropoff_hour&#34;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_dayhour</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">,</span><span class="s2">&#34;dropoff_hour&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">tip_per_dayhour</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&#34;dropoff_hour&#34;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">,</span><span class="n">facet_row</span><span class="o">=</span><span class="s2">&#34;dropoff_day&#34;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;stack&#39;</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">facet_row_spacing</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Monday&#39;</span><span class="p">][</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Monday Mean Tip Amount&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Tuesday&#39;</span><span class="p">][</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Tuesday Mean Tip Amount&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Wednesday&#39;</span><span class="p">][</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Wednesday Mean Tip Amount&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Thursday&#39;</span><span class="p">][</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Thursday Mean Tip Amount&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Friday&#39;</span><span class="p">][</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Friday Mean Tip Amount&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">][</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Saturday Mean Tip Amount&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">][</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">line_dash</span><span class="o">=</span><span class="s2">&#34;dot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&#34;Sunday Mean Tip Amount&#34;</span><span class="p">,</span><span class="n">annotation_position</span><span class="o">=</span><span class="s2">&#34;bottom right&#34;</span><span class="p">,</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span> <span class="o">=</span> <span class="n">tip_dayhour</span><span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span> <span class="o">=</span> <span class="n">tip_dayhour</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Hour&#34;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">tip_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="o">==</span> <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">YAxis</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tip_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="o">==</span> <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">XAxis</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tip_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span> <span class="o">=</span> <span class="n">tip_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">                            <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mf">0.07</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Average Tip Amount&#34;</span><span class="p">,</span><span class="n">textangle</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">xref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">,</span><span class="n">yref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span> <span class="o">=</span> <span class="n">tip_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">                            <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Hour&#34;</span><span class="p">,</span><span class="n">xref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">,</span><span class="n">yref</span><span class="o">=</span><span class="s2">&#34;paper&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span> <span class="o">=</span> <span class="n">tip_dayhour</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_title</span> <span class="o">=</span> <span class="s1">&#39;Day&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_dayhour</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/tip_dayhour.html" height="525" width="100%"></iframe>
<p>This if a slightly harder figure to interpret so let&rsquo;s simplify it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tip_per_dayhour_img</span> <span class="o">=</span> <span class="n">tip_per_dayhour</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;dropoff_hour&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_dayhour_img</span> <span class="o">=</span> <span class="n">tip_per_dayhour_img</span><span class="p">[[</span><span class="s1">&#39;Monday&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuesday&#39;</span><span class="p">,</span> <span class="s1">&#39;Wednesday&#39;</span><span class="p">,</span> <span class="s1">&#39;Thursday&#39;</span><span class="p">,</span> <span class="s1">&#39;Friday&#39;</span><span class="p">,</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_dayhour_img</span> <span class="o">=</span> <span class="n">tip_per_dayhour_img</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_dayhour_img_fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tip_per_dayhour_img</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_dayhour_img_fig</span> <span class="o">=</span> <span class="n">tip_per_dayhour_img_fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Heatmap of Average Tip Amount&#39;</span><span class="p">,</span> <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                               <span class="n">yaxis_title</span><span class="o">=</span> <span class="s1">&#39;Hour&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_dayhour_img_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/tip_per_dayhour_img_fig.html" height="525" width="100%"></iframe>
<h4 id="tip-per-time-of-day">Tip per Time of Day</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tip_per_tday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_time_of_day&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_tday</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_tday</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_tday</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tip_per_tday</span><span class="o">.</span><span class="n">dropoff_time_of_day</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">tip_per_tday</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Tip Amount per Time of Day&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_tday</span> <span class="o">=</span> <span class="n">tip_tday</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount per Time of Day&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Time of Day&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_tday</span> <span class="o">=</span> <span class="n">tip_tday</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_tday</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/tip_tday.html" height="525" width="100%"></iframe>
<h4 id="tip-per-month">Tip per Month</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Average tipping per month</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;January&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;February&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;March&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&#34;April&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;May&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;June&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&#34;July&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="s2">&#34;August&#34;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s2">&#34;September&#34;</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&#34;October&#34;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;November&#34;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">&#34;December&#34;</span><span class="p">:</span><span class="mi">12</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_per_month</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;dropoff_month&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_per_month</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;dropoff_month&#34;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">order_dict</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_month</span><span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_month</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tip_per_month</span><span class="o">.</span><span class="n">dropoff_month</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">tip_per_month</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Tip Amount per Month&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_month</span> <span class="o">=</span> <span class="n">tip_month</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount Per Month&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount&#34;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Month&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_month</span> <span class="o">=</span> <span class="n">tip_month</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_month</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/tip_month.html" height="525" width="100%"></iframe>
<h4 id="tip-per-direction">Tip per Direction</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Average tipping per direction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_per_dir</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;trip_direction&#34;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_dir</span><span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dir</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tip_per_dir</span><span class="o">.</span><span class="n">trip_direction</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">tip_per_dir</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Average Tip Amount per Direction&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_dir</span> <span class="o">=</span> <span class="n">tip_dir</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount Per Direction&#34;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&#34;Average Tip Amount&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                <span class="n">xaxis_title</span> <span class="o">=</span><span class="s2">&#34;Direction&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dir</span> <span class="o">=</span> <span class="n">tip_dir</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_dir</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/tip_dir.html" height="525" width="100%"></iframe>
<p>On average people tip the highest early in the morning (maybe going home drunk from a nightout 😆), lowest at the afternoon. People also tip highest on Wednesdays and lowest on Saturdays but these differences aren&rsquo;t that significant (of a few cents). We can also analyze the tipping behaviour with regards to geographic data.</p>
<h4 id="tip-per-borough">Tip per Borough</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">avg_tip_boroughs</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;pickup_borough&#34;</span><span class="p">,</span><span class="s2">&#34;dropoff_borough&#34;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_tip_boroughs_img</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">avg_tip_boroughs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;pickup_borough&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39;tip_amount&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">avg_tip_boroughs_fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">avg_tip_boroughs_img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">avg_tip_boroughs_img</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;No Trips&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">avg_tip_boroughs_fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">font</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">avg_tip_boroughs_fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">font</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_tip_boroughs_fig</span> <span class="o">=</span> <span class="n">avg_tip_boroughs_fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Average Tip Amount between Borough&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                              <span class="n">xaxis_title</span> <span class="o">=</span> <span class="s1">&#39;Dropoff Borough&#39;</span><span class="p">,</span> <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s1">&#39;Pickup Borough&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">avg_tip_boroughs_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/avg_tip_boroughs_fig.html" height="525" width="100%"></iframe>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tip_borough</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_borough</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tip_borough_fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">tip_borough</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_borough_fig</span> <span class="o">=</span> <span class="n">tip_borough_fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span> <span class="s1">&#39;Average Tip Amount Per Borough&#39;</span><span class="p">,</span> <span class="n">xaxis_title</span> <span class="o">=</span> <span class="s1">&#39;Average Tip Amount&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">yaxis_title</span><span class="o">=</span> <span class="s1">&#39;Borough&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tip_borough_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/tip_borough_fig.html" height="525" width="100%"></iframe>
<p>Queens is the highest tip paying borough when disregarding the low density of trips in Staten Island and the Outside Boroughs</p>
<p>We saw earlier that there isn&rsquo;t a significant difference between the tipping of various time of the day on average but we can also investigate the correlation as well</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">correlation_hour</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">hour_one_hot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_hour</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cor</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">tip_amount</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">hour_one_hot</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">correlation_hour</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cor</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_hour</span><span class="p">,</span><span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.4f&#39;</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;fontsize&#34;</span><span class="p">:</span><span class="mi">12</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;Tip Amount&#39;</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Correlation Matrix between Tip Amount and Hour of Day&#34;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">columns</span><span class="o">=</span><span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_time_of_day</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">correlation_tday</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;tip_amount&#34;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tday_onehot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">dropoff_time_of_day</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cor</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">tip_amount</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tday_onehot</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">correlation_tday</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cor</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_tday</span><span class="p">,</span><span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.4f&#39;</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;fontsize&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;Tip Amount&#39;</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Correlation Matrix between Tip Amount and Time of Day&#34;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/posts/New-York-Taxi-Analysis/corr_thour.png" width="100%">
<img src="/posts/New-York-Taxi-Analysis/corr_tday.png" width="100%">
<p>Again no significant correlation, but we can still go even further with simple linear regression</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">lr</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">tip_amount</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">hour_one_hot</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">lr2</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">tip_amount</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">tday_onehot</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Night&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">lr</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>       <td>tip_amount</td>    <th>  R-squared:         </th>  <td>   0.002</td>  
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th>  <td>   0.002</td>  
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th>  <td>   108.0</td>  
</tr>
<tr>
  <th>Date:</th>             <td>Sun, 30 Oct 2022</td> <th>  Prob (F-statistic):</th>   <td>  0.00</td>   
</tr>
<tr>
  <th>Time:</th>                 <td>06:35:25</td>     <th>  Log-Likelihood:    </th> <td>-2.5450e+06</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>1182030</td>     <th>  AIC:               </th>  <td>5.090e+06</td> 
</tr>
<tr>
  <th>Df Residuals:</th>          <td>1182006</td>     <th>  BIC:               </th>  <td>5.090e+06</td> 
</tr>
<tr>
  <th>Df Model:</th>              <td>    23</td>      <th>                     </th>      <td> </td>     
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>      <td> </td>     
</tr>
</table>
<table class="simpletable">
<tr>
    <td></td>       <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>const</th> <td>    1.4465</td> <td>    0.008</td> <td>  181.745</td> <td> 0.000</td> <td>    1.431</td> <td>    1.462</td>
</tr>
<tr>
  <th>0</th>     <td>    0.0436</td> <td>    0.012</td> <td>    3.664</td> <td> 0.000</td> <td>    0.020</td> <td>    0.067</td>
</tr>
<tr>
  <th>1</th>     <td>   -0.0119</td> <td>    0.014</td> <td>   -0.861</td> <td> 0.389</td> <td>   -0.039</td> <td>    0.015</td>
</tr>
<tr>
  <th>2</th>     <td>   -0.0992</td> <td>    0.015</td> <td>   -6.514</td> <td> 0.000</td> <td>   -0.129</td> <td>   -0.069</td>
</tr>
<tr>
  <th>3</th>     <td>   -0.1342</td> <td>    0.017</td> <td>   -7.934</td> <td> 0.000</td> <td>   -0.167</td> <td>   -0.101</td>
</tr>
<tr>
  <th>4</th>     <td>   -0.1116</td> <td>    0.019</td> <td>   -5.870</td> <td> 0.000</td> <td>   -0.149</td> <td>   -0.074</td>
</tr>
<tr>
  <th>5</th>     <td>    0.2021</td> <td>    0.022</td> <td>    9.390</td> <td> 0.000</td> <td>    0.160</td> <td>    0.244</td>
</tr>
<tr>
  <th>6</th>     <td>    0.0184</td> <td>    0.015</td> <td>    1.189</td> <td> 0.235</td> <td>   -0.012</td> <td>    0.049</td>
</tr>
<tr>
  <th>7</th>     <td>   -0.1275</td> <td>    0.012</td> <td>  -10.354</td> <td> 0.000</td> <td>   -0.152</td> <td>   -0.103</td>
</tr>
<tr>
  <th>8</th>     <td>   -0.0405</td> <td>    0.011</td> <td>   -3.557</td> <td> 0.000</td> <td>   -0.063</td> <td>   -0.018</td>
</tr>
<tr>
  <th>9</th>     <td>   -0.0629</td> <td>    0.011</td> <td>   -5.489</td> <td> 0.000</td> <td>   -0.085</td> <td>   -0.040</td>
</tr>
<tr>
  <th>10</th>    <td>   -0.1860</td> <td>    0.012</td> <td>  -16.050</td> <td> 0.000</td> <td>   -0.209</td> <td>   -0.163</td>
</tr>
<tr>
  <th>11</th>    <td>   -0.2671</td> <td>    0.012</td> <td>  -22.231</td> <td> 0.000</td> <td>   -0.291</td> <td>   -0.244</td>
</tr>
<tr>
  <th>12</th>    <td>   -0.2721</td> <td>    0.012</td> <td>  -22.997</td> <td> 0.000</td> <td>   -0.295</td> <td>   -0.249</td>
</tr>
<tr>
  <th>13</th>    <td>   -0.2713</td> <td>    0.012</td> <td>  -22.860</td> <td> 0.000</td> <td>   -0.295</td> <td>   -0.248</td>
</tr>
<tr>
  <th>14</th>    <td>   -0.2296</td> <td>    0.012</td> <td>  -18.927</td> <td> 0.000</td> <td>   -0.253</td> <td>   -0.206</td>
</tr>
<tr>
  <th>15</th>    <td>   -0.2090</td> <td>    0.012</td> <td>  -16.809</td> <td> 0.000</td> <td>   -0.233</td> <td>   -0.185</td>
</tr>
<tr>
  <th>16</th>    <td>   -0.1547</td> <td>    0.013</td> <td>  -12.346</td> <td> 0.000</td> <td>   -0.179</td> <td>   -0.130</td>
</tr>
<tr>
  <th>17</th>    <td>   -0.1704</td> <td>    0.012</td> <td>  -13.808</td> <td> 0.000</td> <td>   -0.195</td> <td>   -0.146</td>
</tr>
<tr>
  <th>18</th>    <td>   -0.1385</td> <td>    0.011</td> <td>  -12.242</td> <td> 0.000</td> <td>   -0.161</td> <td>   -0.116</td>
</tr>
<tr>
  <th>19</th>    <td>   -0.1376</td> <td>    0.011</td> <td>  -12.407</td> <td> 0.000</td> <td>   -0.159</td> <td>   -0.116</td>
</tr>
<tr>
  <th>20</th>    <td>   -0.1295</td> <td>    0.011</td> <td>  -11.259</td> <td> 0.000</td> <td>   -0.152</td> <td>   -0.107</td>
</tr>
<tr>
  <th>21</th>    <td>   -0.0831</td> <td>    0.012</td> <td>   -7.147</td> <td> 0.000</td> <td>   -0.106</td> <td>   -0.060</td>
</tr>
<tr>
  <th>22</th>    <td>   -0.0468</td> <td>    0.011</td> <td>   -4.097</td> <td> 0.000</td> <td>   -0.069</td> <td>   -0.024</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>1253930.783</td> <th>  Durbin-Watson:     </th>   <td>   2.001</td>   
</tr>
<tr>
  <th>Prob(Omnibus):</th>   <td> 0.000</td>    <th>  Jarque-Bera (JB):  </th> <td>385938280.509</td>
</tr>
<tr>
  <th>Skew:</th>            <td> 4.829</td>    <th>  Prob(JB):          </th>   <td>    0.00</td>   
</tr>
<tr>
  <th>Kurtosis:</th>        <td>90.993</td>    <th>  Cond. No.          </th>   <td>    21.6</td>   
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">lr2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>       <td>tip_amount</td>    <th>  R-squared:         </th>  <td>   0.001</td>  
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th>  <td>   0.001</td>  
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th>  <td>   380.3</td>  
</tr>
<tr>
  <th>Date:</th>             <td>Sun, 30 Oct 2022</td> <th>  Prob (F-statistic):</th>   <td>  0.00</td>   
</tr>
<tr>
  <th>Time:</th>                 <td>06:35:26</td>     <th>  Log-Likelihood:    </th> <td>-2.5454e+06</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>1182030</td>     <th>  AIC:               </th>  <td>5.091e+06</td> 
</tr>
<tr>
  <th>Df Residuals:</th>          <td>1182025</td>     <th>  BIC:               </th>  <td>5.091e+06</td> 
</tr>
<tr>
  <th>Df Model:</th>              <td>     4</td>      <th>                     </th>      <td> </td>     
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>      <td> </td>     
</tr>
</table>
<table class="simpletable">
<tr>
       <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>const</th>      <td>    1.4439</td> <td>    0.005</td> <td>  300.591</td> <td> 0.000</td> <td>    1.434</td> <td>    1.453</td>
</tr>
<tr>
  <th>Afternon</th>   <td>   -0.2440</td> <td>    0.007</td> <td>  -36.964</td> <td> 0.000</td> <td>   -0.257</td> <td>   -0.231</td>
</tr>
<tr>
  <th>Evening</th>    <td>   -0.1314</td> <td>    0.006</td> <td>  -22.143</td> <td> 0.000</td> <td>   -0.143</td> <td>   -0.120</td>
</tr>
<tr>
  <th>Late night</th> <td>   -0.0448</td> <td>    0.008</td> <td>   -5.577</td> <td> 0.000</td> <td>   -0.061</td> <td>   -0.029</td>
</tr>
<tr>
  <th>Morning</th>    <td>   -0.1181</td> <td>    0.006</td> <td>  -19.483</td> <td> 0.000</td> <td>   -0.130</td> <td>   -0.106</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>1253963.407</td> <th>  Durbin-Watson:     </th>   <td>   2.001</td>   
</tr>
<tr>
  <th>Prob(Omnibus):</th>   <td> 0.000</td>    <th>  Jarque-Bera (JB):  </th> <td>385045385.766</td>
</tr>
<tr>
  <th>Skew:</th>            <td> 4.830</td>    <th>  Prob(JB):          </th>   <td>    0.00</td>   
</tr>
<tr>
  <th>Kurtosis:</th>        <td>90.890</td>    <th>  Cond. No.          </th>   <td>    6.67</td>   
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
<p>From this analysis we see that 1AM and 6AM are insignificant while most other hours of the day contribute negatively to the average tipping amount except for 5AM as expected.</p>
<p>We can go even further by trying to model the tipping amount with the features we have. I&rsquo;ll opt for s Random Forest Model, which I will probably write about in the future along with tree models. The code for this is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span> 
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">StandardScaler</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sin_transformer</span><span class="p">(</span><span class="n">period</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">period</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cos_transformer</span><span class="p">(</span><span class="n">period</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">period</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">one_hot_encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_month&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_time_of_day&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">hour_transformer</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s2">&#34;categorical&#34;</span><span class="p">,</span> <span class="n">one_hot_encoder</span><span class="p">,</span> <span class="n">categorical_columns</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s2">&#34;hour_sin&#34;</span><span class="p">,</span> <span class="n">sin_transformer</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="p">[</span><span class="s2">&#34;dropoff_hour&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s2">&#34;hour_cos&#34;</span><span class="p">,</span> <span class="n">cos_transformer</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="p">[</span><span class="s2">&#34;dropoff_hour&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">remainder</span><span class="o">=</span><span class="n">StandardScaler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rf_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">hour_transformer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">RandomForestRegressor</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_day&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_month&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_time_of_day&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_borough&#39;</span><span class="p">,</span><span class="s1">&#39;dropoff_hour&#39;</span><span class="p">,</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="s1">&#39;trip_time_in_secs&#39;</span><span class="p">,</span><span class="s1">&#39;pickup_longitude&#39;</span><span class="p">,</span><span class="s1">&#39;pickup_latitude&#39;</span><span class="p">,</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">tip_amount</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_</span>  <span class="o">=</span> <span class="n">rf_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We also cyclically encode the time feature (dropoff hour), this is usually done when we have cyclical features such as hour of the day, days of the week, and others. This can be achieved by taking the sine and cosine of the cyclical feature divided by the period (total number/maximum number of the feature, i,e. 7 if days of the week and 24 if hours). We also one-hot encode our categorical variables. I&rsquo;ll also write a future article about cyclical encoding of features in the future.  We evaluate how well the model performs on our training data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Coefficient of determination (R^2) of the model is: &#34;</span><span class="p">,</span> <span class="n">rf_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Coefficient of determination (R^2) of the model is: 
0.962619575415421
</code></pre>
<p>Eventually we would like to see the most important deatures that contribute to predicting the tipping amount (More on this in a future article)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">categorical_columns</span><span class="p">]),</span><span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">categorical_columns</span><span class="p">)]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">features</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;dropoff_hour&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;dropoff_hour_sin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">features</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;dropoff_hour_sin&#39;</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;dropoff_hour_cos&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">feature_importance</span> <span class="o">=</span> <span class="n">rf_pipe</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
</span></span><span class="line"><span class="cl"><span class="n">feature_importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Feature Name&#39;</span><span class="p">:</span><span class="n">features</span><span class="p">,</span> <span class="s1">&#39;Importance&#39;</span><span class="p">:</span><span class="n">feature_importance</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">feature_importance_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Importance&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">feature_importance_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">feature_importance_fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">feature_importance_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Importance&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Feature Name&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Feature Name&#39;</span><span class="p">:</span><span class="n">feature_importance_df</span><span class="p">[</span><span class="s1">&#39;Feature Name&#39;</span><span class="p">]},</span><span class="n">height</span><span class="o">=</span><span class="mi">900</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">feature_importance_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><iframe src= "/posts/New-York-Taxi-Analysis/feature_importance_fig.html" height="525" width="100%"></iframe>
<p>We see that a major influencing factor in determining the tipping amount is how long the trip took and what payment method was used (Cash in our case as intuitively that&rsquo;s what most people tip taxi rides with). We can see the correlation between the tip, time taken and distance to confirm that there is a correlation but a weak one.</p>
<img src="/posts/New-York-Taxi-Analysis/tip_corr.png" width="100%">
<p>Seeing this we analyze this again with linear regression modelling the average tipping amount</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">lr_distance</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">tip_amount</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">lr_distance</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>       <td>tip_amount</td>    <th>  R-squared:         </th>  <td>   0.259</td>  
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th>  <td>   0.259</td>  
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th>  <td>4.131e+05</td> 
</tr>
<tr>
  <th>Date:</th>             <td>Sun, 30 Oct 2022</td> <th>  Prob (F-statistic):</th>   <td>  0.00</td>   
</tr>
<tr>
  <th>Time:</th>                 <td>08:03:25</td>     <th>  Log-Likelihood:    </th> <td>-2.3691e+06</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>1182030</td>     <th>  AIC:               </th>  <td>4.738e+06</td> 
</tr>
<tr>
  <th>Df Residuals:</th>          <td>1182028</td>     <th>  BIC:               </th>  <td>4.738e+06</td> 
</tr>
<tr>
  <th>Df Model:</th>              <td>     1</td>      <th>                     </th>      <td> </td>     
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>      <td> </td>     
</tr>
</table>
<table class="simpletable">
<tr>
        <td></td>           <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>const</th>         <td>    0.3976</td> <td>    0.002</td> <td>  181.351</td> <td> 0.000</td> <td>    0.393</td> <td>    0.402</td>
</tr>
<tr>
  <th>trip_distance</th> <td>    0.3109</td> <td>    0.000</td> <td>  642.736</td> <td> 0.000</td> <td>    0.310</td> <td>    0.312</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>1150484.269</td> <th>  Durbin-Watson:     </th>   <td>   2.002</td>   
</tr>
<tr>
  <th>Prob(Omnibus):</th>   <td> 0.000</td>    <th>  Jarque-Bera (JB):  </th> <td>903227788.715</td>
</tr>
<tr>
  <th>Skew:</th>            <td> 3.820</td>    <th>  Prob(JB):          </th>   <td>    0.00</td>   
</tr>
<tr>
  <th>Kurtosis:</th>        <td>138.207</td>   <th>  Cond. No.          </th>   <td>    6.15</td>   
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
<p>A positive contribution</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">scaled_duration</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">trip_time_in_secs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl"><span class="n">lr_duration</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">tip_amount</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">scaled_duration</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">lr_duration</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>       <td>tip_amount</td>    <th>  R-squared:         </th>  <td>   0.201</td>  
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th>  <td>   0.201</td>  
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th>  <td>2.976e+05</td> 
</tr>
<tr>
  <th>Date:</th>             <td>Sun, 30 Oct 2022</td> <th>  Prob (F-statistic):</th>   <td>  0.00</td>   
</tr>
<tr>
  <th>Time:</th>                 <td>08:03:26</td>     <th>  Log-Likelihood:    </th> <td>-2.4135e+06</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>1182030</td>     <th>  AIC:               </th>  <td>4.827e+06</td> 
</tr>
<tr>
  <th>Df Residuals:</th>          <td>1182028</td>     <th>  BIC:               </th>  <td>4.827e+06</td> 
</tr>
<tr>
  <th>Df Model:</th>              <td>     1</td>      <th>                     </th>      <td> </td>     
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>      <td> </td>     
</tr>
</table>
<table class="simpletable">
<tr>
    <td></td>       <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>const</th> <td>    1.3245</td> <td>    0.002</td> <td>  772.412</td> <td> 0.000</td> <td>    1.321</td> <td>    1.328</td>
</tr>
<tr>
  <th>x1</th>    <td>    0.9355</td> <td>    0.002</td> <td>  545.563</td> <td> 0.000</td> <td>    0.932</td> <td>    0.939</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>1204548.432</td> <th>  Durbin-Watson:     </th>   <td>   2.001</td>   
</tr>
<tr>
  <th>Prob(Omnibus):</th>   <td> 0.000</td>    <th>  Jarque-Bera (JB):  </th> <td>758035989.092</td>
</tr>
<tr>
  <th>Skew:</th>            <td> 4.241</td>    <th>  Prob(JB):          </th>   <td>    0.00</td>   
</tr>
<tr>
  <th>Kurtosis:</th>        <td>126.771</td>   <th>  Cond. No.          </th>   <td>    1.00</td>   
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;On Average </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">lr_duration</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds or 20 minutes contribute to a 1 dollar tip&#34;</span><span class="p">)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>On Average 1249.0 seconds or 20 minutes contribute to a 
1 dollar tip
</code></pre>
<p>This sums up our findings and this article. I have conducted other analysis as well as a prediction model for predicting the pickup density after clustering New York into several buckets/regions and binning of time. All of this can be found in the projects GitHub repository.</p>
<p>Thank you for reading and if you have any questions regarding the project I&rsquo;m an email away. Until next time, Bye!
</span></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://arebimohammed.github.io/new-york-taxi-analysis/" data-title="Digging Deep Into the New York Taxi Dataset" data-hashtags="blogging,data science,machine learning,project,python,data analysis"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://arebimohammed.github.io/new-york-taxi-analysis/" data-hashtag="blogging"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://arebimohammed.github.io/new-york-taxi-analysis/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="https://arebimohammed.github.io/new-york-taxi-analysis/" data-title="Digging Deep Into the New York Taxi Dataset" data-web><i class="fab fa-whatsapp fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/blogging/">blogging</a>,&nbsp;<a href="/tags/data-science/">data science</a>,&nbsp;<a href="/tags/machine-learning/">machine learning</a>,&nbsp;<a href="/tags/project/">project</a>,&nbsp;<a href="/tags/python/">python</a>,&nbsp;<a href="/tags/data-analysis/">data analysis</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/applying-oversampling/" class="prev" rel="prev" title="Applying Over-Sampling Methods to Highly Imbalanced Data"><i class="fas fa-angle-left fa-fw"></i>Applying Over-Sampling Methods to Highly Imbalanced Data</a>
            <a href="/confounding-variables/" class="next" rel="next" title="Confounding Variables in Regression Analysis">Confounding Variables in Regression Analysis<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Mohammed Arebi</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":60},"comment":{},"data":{"id-1":"Mohammed Arebi","id-2":"Mohammed Arebi"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"$$","right":"$$"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"},{"display":false,"left":"$","right":"$"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":5,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
